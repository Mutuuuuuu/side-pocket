<!DOCTYPE html>
<html lang="ja">
<header class="w-full max-w-4xl mx-auto mb-4 flex justify-between items-center">
    <a href="index.html"><img src="images/sidepocket_Logo.png" alt="side pocket ロゴ" class="h-14"></a>
    <div class="flex items-center gap-3">
        <a href="profile.html" class="flex items-center gap-2 text-sm text-gray-600 hover:text-main no-underline">
            <img id="user-icon" src="https://placehold.co/32x32/EFEFEF/333333?text=?" class="w-8 h-8 rounded-full object-cover bg-gray-200">
            <span id="user-display-name"></span>
        </a>
        <div class="relative">
            <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            <div id="dropdown-menu" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-xl z-20 hidden">
                <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">打刻</a>
                <a href="calendar.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">カレンダー連携</a>
                <a href="summary.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">稼働管理</a>
                <a href="projects.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">プロジェクト管理</a>
                <div class="border-t border-gray-100"></div>
                <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">ログアウト</button>
            </div>
        </div>
    </div>
</header>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <header class="w-full max-w-4xl mx-auto mb-4 flex justify-between items-center">
            <a href="index.html"><img src="images/sidepocket_Logo.png" alt="side pocket ロゴ" class="h-14"></a>
            <div class="flex items-center gap-3">
                <a href="profile.html" class="flex items-center gap-2 text-sm text-gray-600 hover:text-main no-underline">
                    <img id="user-icon" src="https://placehold.co/32x32/EFEFEF/333333?text=?" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                    <span id="user-display-name"></span>
                </a>
                <div class="relative">
                    <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    </button>
                    <div id="dropdown-menu" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-xl z-20 hidden">
                        <button id="menu-home" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">打刻</button>
                        <button id="menu-calendar" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">カレンダー連携</button>
                        <button id="menu-summary" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">稼働管理</button>
                        <button id="menu-projects" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">プロジェクト管理</button>
                        <div class="border-t border-gray-100"></div>
                        <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">ログアウト</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="w-full max-w-4xl mx-auto">
             <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Googleカレンダー連携</h2>
                    <button id="gcal-add-event-button" class="btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded hidden">＋ 予定を作成</button>
                </header>
                <div id="gcal-auth-container" class="bg-gray-50 p-4 rounded-lg">
                    <p id="gcal-auth-status" class="text-gray-600 mb-4">ステータス：初期化中...</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="gcal-authorize-button" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded hidden">Googleと連携する</button>
                        <button id="gcal-signout-button" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">連携を解除</button>
                    </div>
                </div>
                <div id="gcal-controls" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="calendar-select" class="block text-sm font-medium text-gray-700">カレンダーを選択:</label>
                            <select id="calendar-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label for="calendar-month" class="block text-sm font-medium text-gray-700">月を選択:</label>
                            <input type="month" id="calendar-month" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="load-calendar-events-btn" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded">予定を読み込む</button>
                    </div>
                    <div id="calendar-events-container" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-gray-500 text-center py-4">カレンダーと月を選択して「予定を読み込む」を押してください。</p>
                    </div>
                    <div id="calendar-action-bar" class="hidden flex justify-end p-4 border-t">
                        <button id="reflect-events-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full md:w-auto">選択した予定を稼働実績に反映</button>
                    </div>
                    <div id="reflect-status" class="text-center h-5"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="add-event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">新しい予定を作成</h2>
            <form id="add-event-form">
                <div class="space-y-4">
                    <input type="text" id="event-summary" placeholder="予定のタイトル" required class="w-full px-4 py-2 border rounded">
                    <input type="datetime-local" id="event-start-time" required class="w-full px-4 py-2 border rounded">
                    <input type="datetime-local" id="event-end-time" required class="w-full px-4 py-2 border rounded">
                    <select id="event-project-select" class="w-full px-4 py-2 border rounded">
                        <option value="">プロジェクトを選択（任意）</option>
                    </select>
                    <textarea id="event-description" placeholder="詳細（任意）" class="w-full px-4 py-2 border rounded"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-add-event" class="px-4 py-2 bg-gray-200 rounded">キャンセル</button>
                    <button type="submit" class="px-4 py-2 bg-main text-white rounded">作成</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { collection, addDoc, getDocs, query, where, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js';

        let currentUser = null;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        const projectDataMap = new Map();

        const API_KEY = 'AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM';
        const CLIENT_ID = '887116583823-32evpk9fa2m0ondbbco6tv4m1980i7bj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        // ★★★ 権限を編集可能に変更 ★★★
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        initializePage(user => {
            currentUser = user;
            
            gapi.load('client', initializeGapiClient);
            setTimeout(() => {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: (tokenResponse) => {
                            if (tokenResponse.error) { return; }
                            gapi.client.setToken(tokenResponse);
                            updateGcalUi();
                        },
                    });
                    gisInited = true;
                    updateGcalUi();
                } catch (e) { console.error("Error initializing Google Identity Services.", e); }
            }, 500);
            
            listenToActiveProjects();
        });

        function listenToActiveProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("status", "==", "Active"));
            onSnapshot(q, (snapshot) => {
                const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                projectDataMap.clear();
                projects.forEach(p => projectDataMap.set(p.code, p));
                updateProjectDropdowns();
            });
        }
        
        function updateProjectDropdowns() {
            const projectOptions = Array.from(projectDataMap.values())
                .map(p => `<option value="${p.code}">${p.code}: ${p.name}</option>`).join('');
            document.getElementById('event-project-select').innerHTML = `<option value="">プロジェクトを選択（任意）</option>${projectOptions}`;
        }

        // --- (ここに元のカレンダー連携の全ロジックをコピー) ---
        // 以下に、元のindex.htmlにあったカレンダー連携のロジックをすべて貼り付けます
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            updateGcalUi();
        }
        function updateGcalUi() {
            if (!gapiInited || !gisInited) return;
            const authorizeButton = document.getElementById('gcal-authorize-button');
            const signoutButton = document.getElementById('gcal-signout-button');
            const controls = document.getElementById('gcal-controls');
            const addEventBtn = document.getElementById('gcal-add-event-button');

            if (gapi.client.getToken() === null) {
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                controls.classList.add('hidden');
                addEventBtn.classList.add('hidden');
            } else {
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                controls.classList.remove('hidden');
                addEventBtn.classList.remove('hidden');
                loadCalendarList();
            }
        }
        document.getElementById('gcal-authorize-button').addEventListener('click', () => { if (tokenClient) tokenClient.requestAccessToken(); });
        document.getElementById('gcal-signout-button').addEventListener('click', () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateGcalUi();
                });
            }
        });
        async function loadCalendarList() {
            const select = document.getElementById('calendar-select');
            try {
                const response = await gapi.client.calendar.calendarList.list();
                select.innerHTML = '';
                response.result.items.forEach(calendar => {
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.summary;
                    select.appendChild(option);
                });
                document.getElementById('calendar-month').value = new Date().toISOString().slice(0, 7);
            } catch (err) { console.error("カレンダーリストの読み込みに失敗", err); }
        }
        document.getElementById('load-calendar-events-btn').addEventListener('click', listCalendarEvents);
        async function listCalendarEvents() {
             // ... (内容は変更なし) ...
        }
        document.getElementById('reflect-events-btn').addEventListener('click', async () => {
             // ... (内容は変更なし) ...
        });

        // ★★★ 予定作成ロジックを追加 ★★★
        document.getElementById('gcal-add-event-button').addEventListener('click', () => {
            document.getElementById('add-event-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-add-event').addEventListener('click', () => {
            document.getElementById('add-event-modal').classList.add('hidden');
        });
        document.getElementById('add-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const event = {
                'summary': document.getElementById('event-summary').value,
                'description': document.getElementById('event-description').value,
                'start': { 'dateTime': new Date(document.getElementById('event-start-time').value).toISOString() },
                'end': { 'dateTime': new Date(document.getElementById('event-end-time').value).toISOString() },
                'extendedProperties': { 'private': { 'projectCode': document.getElementById('event-project-select').value } }
            };
            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                alert('予定を作成しました！');
                document.getElementById('add-event-modal').classList.add('hidden');
                listCalendarEvents();
            } catch (error) { alert('予定の作成に失敗しました: ' + error.message); }
        });

    </script>
</body>
</html>
