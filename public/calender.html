<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>カレンダー連携 - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <div id="header-placeholder"></div>

        <main class="w-full max-w-4xl mx-auto">
             <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Googleカレンダー連携</h2>
                    <button id="gcal-add-event-button" class="btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded hidden">＋ 予定を作成</button>
                </header>
                <div id="gcal-auth-container" class="bg-gray-50 p-4 rounded-lg">
                    <p id="gcal-auth-status" class="text-gray-600 mb-4">ステータス：初期化中...</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="gcal-authorize-button" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded hidden">Googleと連携する</button>
                        <button id="gcal-signout-button" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">連携を解除</button>
                    </div>
                </div>
                <div id="gcal-controls" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="calendar-select" class="block text-sm font-medium text-gray-700">カレンダーを選択:</label>
                            <select id="calendar-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label for="calendar-month" class="block text-sm font-medium text-gray-700">月を選択:</label>
                            <input type="month" id="calendar-month" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="load-calendar-events-btn" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded">予定を読み込む</button>
                    </div>
                    <div id="calendar-events-container" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-gray-500 text-center py-4">カレンダーと月を選択して「予定を読み込む」を押してください。</p>
                    </div>
                    <div id="calendar-action-bar" class="hidden flex justify-end p-4 border-t">
                        <button id="reflect-events-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full md:w-auto">選択した予定を稼働実績に反映</button>
                    </div>
                    <div id="reflect-status" class="text-center h-5"></div>
                </div>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { collection, addDoc, query, where, onSnapshot, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js';

        let currentUser = null;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        const projectDataMap = new Map();

        const API_KEY = 'AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM';
        const CLIENT_ID = '887116583823-32evpk9fa2m0ondbbco6tv4m1980i7bj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        initializePage(user => {
            currentUser = user;
            
            gapi.load('client', initializeGapiClient);
            setTimeout(() => {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: (tokenResponse) => {
                            if (tokenResponse.error) { return; }
                            gapi.client.setToken(tokenResponse);
                            updateGcalUi();
                        },
                    });
                    gisInited = true;
                    updateGcalUi();
                } catch (e) { console.error("Error initializing Google Identity Services.", e); }
            }, 500);
            
            listenToActiveProjects();
        });
        
        function listenToActiveProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("status", "==", "Active"));
            onSnapshot(q, (snapshot) => {
                projectDataMap.clear();
                snapshot.forEach(doc => {
                    projectDataMap.set(doc.data().code, { id: doc.id, ...doc.data() });
                });
            });
        }

        // ... (ここにカレンダー連携の全ロジックをコピー) ...
    </script>
</body>
</html>
