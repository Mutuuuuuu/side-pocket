<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>稼働管理 - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <div id="header-placeholder"></div>

        <main class="w-full max-w-4xl mx-auto">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">稼働管理</h2></header>
                <div class="bg-gray-50 p-4 rounded-lg"><canvas id="monthlyChart"></canvas></div>
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <label for="monthSelector" class="text-sm font-medium text-gray-700">表示月を選択:</label>
                        <select id="monthSelector" class="mt-1 block w-full sm:w-auto p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div id="monthTotalHours" class="text-lg font-bold text-right text-gray-800"></div>
                </div>
                <div id="detailsContainer">
                    <div id="projectTabs" class="border-b border-gray-200"></div>
                    <div id="projectTabContent" class="mt-4"></div>
                </div>
                <div id="summaryStatus" class="pt-2 text-center text-gray-600 font-medium h-8"></div>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js';
        import { IPAEXG_FONT_B64 } from './fonts.js';

        let currentUser = null;
        let fullDashboardData = {};
        let monthlyChartInstance = null;
        let timestampsUnsubscribe = null;
        let allProjects = [];

        initializePage(user => {
            currentUser = user;
            listenToAllProjects();
            listenToTimestamps();
        });

        function listenToAllProjects() {
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (Object.keys(fullDashboardData).length > 0) {
                    processDashboardData(fullDashboardData.rawRecords, getProjectsMap());
                }
            });
        }

        function getProjectsMap() {
            const projectsMap = {};
            allProjects.forEach(project => {
                projectsMap[project.code] = { name: project.name, color: project.color || '#698966' };
            });
            return projectsMap;
        }

        function listenToTimestamps() {
            if (!currentUser) return;
            showStatus('データを読み込んでいます...', false, 'summaryStatus');
            if (timestampsUnsubscribe) timestampsUnsubscribe();
            const q = query(collection(db, "timestamps"), where("userId", "==", currentUser.uid), orderBy("clockInTime", "desc"));
            timestampsUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const projectsMap = getProjectsMap();
                processDashboardData(records, projectsMap);
                showStatus('', false, 'summaryStatus');
            }, (error) => {
                showStatus(`エラー: ${error.message}`, true, 'summaryStatus');
            });
        }
        
        function processDashboardData(records, projectsMap) {
            fullDashboardData.rawRecords = records; // Store raw records for re-processing
            const monthlyData = {};
            records.forEach(record => {
                if (!record.clockInTime) return;
                const clockInTime = record.clockInTime.toDate();
                const yearMonth = `${clockInTime.getFullYear()}-${(clockInTime.getMonth() + 1).toString().padStart(2, '0')}`;
                const projectCode = record.projectCode || '未指定';
                const duration = record.durationHours || 0;
                if (!monthlyData[yearMonth]) monthlyData[yearMonth] = {};
                if (!monthlyData[yearMonth][projectCode]) {
                    const projectName = projectsMap[projectCode]?.name || record.projectName || projectCode;
                    monthlyData[yearMonth][projectCode] = { projectName: projectName, total: 0, details: [] };
                }
                monthlyData[yearMonth][projectCode].total += duration;
                if (record.durationHours !== null) {
                    monthlyData[yearMonth][projectCode].details.push({
                        recordId: record.id, date: clockInTime.toLocaleDateString('ja-JP'),
                        clockIn: clockInTime,
                        clockOut: record.clockOutTime ? record.clockOutTime.toDate() : null,
                        duration: duration.toFixed(2),
                        projectCode: projectCode
                    });
                }
            });

            fullDashboardData.monthly = monthlyData;
            const allMonths = Object.keys(monthlyData).sort();
            const allProjectCodes = [...new Set(Object.values(monthlyData).flatMap(month => Object.keys(month)))];
            const datasets = allProjectCodes.map(projectCode => {
                const projectInfo = projectsMap[projectCode] || {};
                const color = projectInfo.color || '#698966';
                const dataPoints = allMonths.map(month => monthlyData[month][projectCode]?.total || 0);
                return { label: `${projectInfo.name || projectCode}`, data: dataPoints, borderColor: color, backgroundColor: color, fill: false };
            });
            renderMonthlyChart({ labels: allMonths, datasets });

            const availableMonths = Object.keys(fullDashboardData.monthly).sort().reverse();
            const monthSelector = document.getElementById('monthSelector');
            const currentMonth = monthSelector.value;
            monthSelector.innerHTML = availableMonths.map(month => `<option value="${month}">${month}</option>`).join('');
            
            if (availableMonths.includes(currentMonth)) {
                monthSelector.value = currentMonth;
            }

            if (availableMonths.length > 0) {
                renderMonthData(monthSelector.value || availableMonths[0]);
            } else {
                document.getElementById('detailsContainer').innerHTML = '<p class="text-center text-gray-500 py-4">表示できるデータがありません。</p>';
                document.getElementById('monthTotalHours').textContent = '';
            }
        }

        function renderMonthlyChart(graphData) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChartInstance) {
                monthlyChartInstance.data = graphData;
                monthlyChartInstance.update();
            } else {
                monthlyChartInstance = new Chart(ctx, {
                    type: 'line', data: graphData,
                    options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: value => value + 'h' } } } }
                });
            }
        }

        document.getElementById('monthSelector').addEventListener('change', (e) => renderMonthData(e.target.value));

        function renderMonthData(month) {
            const dataForMonth = fullDashboardData.monthly[month] || {};
            const projects = Object.keys(dataForMonth);
            const tabsContainer = document.getElementById('projectTabs');
            const contentContainer = document.getElementById('projectTabContent');
            let monthGrandTotal = 0;

            if (projects.length === 0) {
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '<p class="text-center text-gray-500 py-4">この月には記録がありません。</p>';
                document.getElementById('monthTotalHours').textContent = '';
                return;
            }
            tabsContainer.innerHTML = `<nav class="-mb-px flex space-x-4 overflow-x-auto">${projects.map((p, i) => `<button data-project="${p}" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${i===0 ? 'active border-main' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">${dataForMonth[p].projectName}</button>`).join('')}</nav>`;
            contentContainer.innerHTML = projects.map((p, i) => {
                const projectData = dataForMonth[p];
                const totalHours = projectData.total.toFixed(2);
                monthGrandTotal += projectData.total;
                let detailsHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">出勤</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">退勤</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">時間(h)</th>
                    </tr></thead><tbody>
                    ${projectData.details.sort((a, b) => new Date(a.clockIn) - new Date(b.clockIn)).map(d => `<tr>
                        <td class="px-4 py-2 text-sm">${d.clockIn.toLocaleString('ja-JP')}</td>
                        <td class="px-4 py-2 text-sm">${d.clockOut ? d.clockOut.toLocaleString('ja-JP') : '勤務中'}</td>
                        <td class="px-4 py-2 text-sm text-right">${d.duration}</td>
                    </tr>`).join('')}
                </tbody></table></div>`;
                return `<div data-content="${p}" class="${i===0 ? '' : 'hidden'}">
                    <div class="flex flex-col sm:flex-row justify-between items-center p-4 bg-main-light rounded-lg gap-4">
                        <h3 class="text-lg font-bold">プロジェクト合計: <span class="text-main">${totalHours}</span> 時間</h3>
                        <button data-month="${month}" data-project="${p}" class="download-pdf-btn btn w-full sm:w-auto text-white bg-main hover:bg-main-dark px-4 py-2 rounded-lg">PDF出力</button>
                    </div>
                    <div class="mt-4">${detailsHtml}</div>
                </div>`;
            }).join('');
            document.getElementById('monthTotalHours').textContent = `月間合計: ${monthGrandTotal.toFixed(2)} 時間`;
            tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
                const targetProject = btn.dataset.project;
                tabsContainer.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'border-main');
                    b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    if (b.dataset.project === targetProject) {
                        b.classList.add('active', 'border-main');
                        b.classList.remove('border-transparent', 'text-gray-500');
                    }
                });
                contentContainer.querySelectorAll('[data-content]').forEach(c => c.classList.toggle('hidden', c.dataset.content !== targetProject));
            }));
        }

        document.getElementById('detailsContainer').addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('download-pdf-btn')) {
                downloadPdf(e.target.dataset.month, e.target.dataset.project);
            }
        });

        function downloadPdf(month, projectCode) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const projectData = fullDashboardData.monthly[month]?.[projectCode];
            if (!projectData) return;
            doc.addFileToVFS("ipaexg.ttf", IPAEXG_FONT_B64);
            doc.addFont("ipaexg.ttf", "ipaexg", "normal");
            doc.setFont("ipaexg");
            doc.setFontSize(18);
            doc.text(`${month} 稼働時間報告書`, 14, 22);
            doc.setFontSize(14);
            doc.text(`${projectData.projectName} (${projectCode})`, 14, 32);
            doc.setFontSize(12);
            doc.text(`合計時間: ${projectData.total.toFixed(2)} 時間`, 14, 42);
            const tableColumn = ["日付", "出勤", "退勤", "時間(h)"];
            const tableRows = [];
            projectData.details.sort((a, b) => new Date(a.clockIn) - new Date(b.clockIn)).forEach(detail => {
                const datePart = detail.date.split(' ')[0];
                const clockInTimePart = (detail.clockIn || "").toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                const clockOutTimePart = (detail.clockOut || "").toLocaleString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                tableRows.push([datePart, clockInTimePart, clockOutTimePart, detail.duration]);
            });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 50, styles: { font: "ipaexg", fontStyle: 'normal' }, headStyles: { fillColor: [105, 137, 102] }, margin: { top: 10, right: 10, bottom: 10, left: 10 } });
            doc.save(`稼働報告書_${month}_${projectCode}.pdf`);
        }
    </script>
</body>
</html>
