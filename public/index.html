<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <title>Firebase版 打刻アプリ</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='45' fill='white' stroke='black' stroke-width='5'/%3e%3cpath d='M50 20 V50 H75' fill='none' stroke='black' stroke-width='5' %3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- ★★★ 修正点 ★★★ Google API Client Libraries -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-button.active { border-color: #3B82F6; color: #3B82F6; background-color: #EFF6FF; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">打刻システム</h1>
        <div class="flex items-center space-x-4">
            <div id="user-info" class="text-right hidden">
                <p id="user-name" class="font-semibold"></p>
                <p id="user-email" class="text-sm text-gray-500"></p>
            </div>
            <img id="user-icon" class="w-12 h-12 rounded-full hidden" src="https://placehold.co/100x100/ccc/fff?text=User">
            <div class="relative">
                <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
                <div id="dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20 hidden">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">プロフィール管理</a>
                    <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ログアウト</button>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 md:p-8">
        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center h-64">
            <div class="loader"></div>
            <p class="ml-4 text-lg">データを読み込んでいます...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="tab-punch">打刻</button>
                    <button class="tab-button" data-tab="tab-calendar">カレンダー連携</button>
                    <button class="tab-button" data-tab="tab-report">月次レポート</button>
                    <button class="tab-button" data-tab="tab-projects">プロジェクト管理</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-punch" class="tab-content active">
                <!-- 打刻セクション (既存のまま) -->
            </div>

            <!-- ★★★ 新しいセクション ★★★ -->
            <div id="tab-calendar" class="tab-content space-y-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Googleカレンダー連携</h2>
                    <p id="gcal-auth-status" class="text-gray-600 mb-4">ステータス：未認証</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="gcal-authorize-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Googleと連携する</button>
                        <button id="gcal-signout-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">連携を解除</button>
                        <button id="gcal-load-events-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded hidden">予定を読み込む</button>
                        <button id="gcal-add-event-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded hidden">予定を作成</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-bold mb-2">カレンダーの予定</h3>
                     <div id="calendar-events-container" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- ここに予定が表示されます -->
                        <p class="text-gray-500">連携後に「予定を読み込む」ボタンを押してください。</p>
                     </div>
                </div>
            </div>

            <div id="tab-report" class="tab-content">
                <!-- 月次レポートセクション (既存のまま) -->
            </div>
            <div id="tab-projects" class="tab-content">
                <!-- プロジェクト管理セクション (既存のまま) -->
            </div>
        </div>
    </main>

    <!-- ★★★ 新しいモーダル ★★★ -->
    <div id="add-event-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">新しい予定を作成</h2>
            <form id="add-event-form">
                <div class="space-y-4">
                    <input type="text" id="event-summary" placeholder="予定のタイトル" required class="w-full px-4 py-2 border rounded">
                    <input type="datetime-local" id="event-start-time" required class="w-full px-4 py-2 border rounded">
                    <input type="datetime-local" id="event-end-time" required class="w-full px-4 py-2 border rounded">
                    <select id="event-project-select" class="w-full px-4 py-2 border rounded">
                        <option value="">プロジェクトを選択（任意）</option>
                        <!-- プロジェクトが動的に追加されます -->
                    </select>
                    <textarea id="event-description" placeholder="詳細（任意）" class="w-full px-4 py-2 border rounded"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-add-event" class="px-4 py-2 bg-gray-200 rounded">キャンセル</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded">作成</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { IPAEXG_FONT_B64 } from './fonts.js';

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★★★ ここにあなたのAPIキーとクライアントIDを入力してください ★★★
        const API_KEY = 'AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM';
        const CLIENT_ID = '887116583823-32evpk9fa2m0ondbbco6tv4m1980i7bj.apps.googleusercontent.com';
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const firebaseConfig = {
            apiKey: "AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM",
            authDomain: "side-pocket-sl.firebaseapp.com",
            projectId: "side-pocket-sl",
            storageBucket: "side-pocket-sl.firebasestorage.app",
            messagingSenderId: "887116583823",
            appId: "1:887116583823:web:5783488bd573f5be4bf1fa",
            measurementId: "G-QSBDN1TX68"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let projects = [];

        // 既存の打刻、レポート、プロジェクト管理のコードはここにペーストしてください
        // (このサンプルでは省略しますが、あなたの元のコードをここに移動します)

        // --- タブ切り替えロジック ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const target = document.getElementById(tab.dataset.tab);
                tabContents.forEach(content => content.classList.remove('active'));
                target.classList.add('active');
            });
        });

        // --- メニュー表示ロジック ---
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        menuButton.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        // --- 認証状態の監視 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // ユーザー情報を表示
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('user-name').textContent = userData.displayName || '名無しさん';
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-icon').src = userData.photoURL || 'https://placehold.co/100x100/ccc/fff?text=User';
                }
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-icon').classList.remove('hidden');
                
                // ★★★ 修正点 ★★★
                // Google APIクライアントの初期化
                gapi.load('client', initializeGapiClient);
                
                // GISクライアントの初期化
                // 'google'オブジェクトがロードされるのを待つ必要があるため、少し遅延させる
                setTimeout(() => {
                    try {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID,
                            scope: SCOPES,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) {
                                    console.error('Authorization error:', tokenResponse.error);
                                    return;
                                }
                                gapi.client.setToken(tokenResponse);
                                updateGcalUi();
                            },
                        });
                        gisInited = true;
                        updateGcalUi();
                    } catch (e) {
                        console.error("Error initializing Google Identity Services. It might not be loaded yet.", e);
                    }
                }, 1000); // 1秒待つ

                // メインコンテンツを表示
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');

                // プロジェクト読み込みなど、ログイン後の初期化処理
                await loadProjects();
                
                // 30分ごとに自動打刻チェック
                setInterval(checkForAutoPunch, 30 * 60 * 1000); 

            } else {
                window.location.href = 'login.html';
            }
        });

        // --- ログアウト処理 ---
        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // ==================================================
        // ★★★ ここからGoogleカレンダー連携の新しいコード ★★★
        // ==================================================
        
        // --- Google APIクライアントの初期化 ---
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                updateGcalUi();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
                document.getElementById('gcal-auth-status').textContent = 'エラー: Google APIの初期化に失敗しました。APIキーが正しいか確認してください。';
            }
        }

        // --- 連携ボタンなどのUI更新 ---
        function updateGcalUi() {
            // gapiとgisの両方が初期化されるまで何もしない
            if (!gapiInited || !gisInited) {
                return;
            }

            const authorizeButton = document.getElementById('gcal-authorize-button');
            const signoutButton = document.getElementById('gcal-signout-button');
            const loadEventsButton = document.getElementById('gcal-load-events-button');
            const addEventButton = document.getElementById('gcal-add-event-button');
            const statusText = document.getElementById('gcal-auth-status');

            if (gapi.client.getToken() === null) {
                // 未認証
                statusText.textContent = 'ステータス：未認証。Googleアカウントと連携してください。';
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                loadEventsButton.classList.add('hidden');
                addEventButton.classList.add('hidden');
            } else {
                // 認証済み
                statusText.textContent = 'ステータス：連携済みです。';
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                loadEventsButton.classList.remove('hidden');
                addEventButton.classList.remove('hidden');
            }
        }

        // --- 連携/認証処理 ---
        document.getElementById('gcal-authorize-button').addEventListener('click', () => {
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                console.error("Token client is not initialized.");
                alert("認証の準備ができていません。少し待ってからもう一度お試しください。");
            }
        });

        // --- 連携解除処理 ---
        document.getElementById('gcal-signout-button').addEventListener('click', () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateGcalUi();
                    document.getElementById('calendar-events-container').innerHTML = '<p class="text-gray-500">連携を解除しました。</p>';
                });
            }
        });

        // --- 予定の読み込み処理 ---
        document.getElementById('gcal-load-events-button').addEventListener('click', listUpcomingEvents);
        
        async function listUpcomingEvents() {
            const container = document.getElementById('calendar-events-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            let response;
            try {
                const request = {
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime',
                };
                response = await gapi.client.calendar.events.list(request);
            } catch (err) {
                container.innerText = 'エラー: ' + err.message;
                return;
            }

            const events = response.result.items;
            if (!events || events.length == 0) {
                container.innerText = '直近の予定はありません。';
                return;
            }
            
            container.innerHTML = ''; // コンテナをクリア
            events.forEach(event => {
                const start = event.start.dateTime || event.start.date;
                const projectInfo = event.extendedProperties?.private?.projectId ? `【${projects.find(p => p.id === event.extendedProperties.private.projectId)?.name || '不明なプロジェクト'}】` : '';
                const eventEl = document.createElement('div');
                eventEl.className = 'p-2 border rounded bg-gray-50';
                eventEl.innerHTML = `<p class="font-bold">${event.summary} ${projectInfo}</p><p class="text-sm text-gray-600">${new Date(start).toLocaleString()}</p>`;
                container.appendChild(eventEl);
            });
        }

        // --- 予定作成モーダルの表示/非表示 ---
        const addEventModal = document.getElementById('add-event-modal');
        document.getElementById('gcal-add-event-button').addEventListener('click', () => {
            addEventModal.classList.remove('hidden');
            addEventModal.classList.add('flex');
        });
        document.getElementById('cancel-add-event').addEventListener('click', () => {
            addEventModal.classList.add('hidden');
            addEventModal.classList.remove('flex');
        });
        
        // --- 予定作成処理 ---
        document.getElementById('add-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const summary = document.getElementById('event-summary').value;
            const startTime = document.getElementById('event-start-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const projectId = document.getElementById('event-project-select').value;
            const description = document.getElementById('event-description').value;

            const event = {
                'summary': summary,
                'description': description,
                'start': { 'dateTime': new Date(startTime).toISOString() },
                'end': { 'dateTime': new Date(endTime).toISOString() },
                'extendedProperties': {
                    'private': {
                        'projectId': projectId,
                        'autoPunch': 'pending' // 自動打刻の状態
                    }
                }
            };
            
            try {
                const request = gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event,
                });
                await request;
                alert('予定を作成しました！');
                addEventModal.classList.add('hidden');
                listUpcomingEvents(); // 予定リストを更新
            } catch (error) {
                alert('予定の作成に失敗しました: ' + error.message);
            }
        });
        
        // --- 自動打刻チェック機能 ---
        async function checkForAutoPunch() {
            if (gapi.client.getToken() === null) return; // 未連携なら何もしない

            console.log("自動打刻チェックを実行中...");
            const now = new Date();
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(now.getDate() - 3);

            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': threeDaysAgo.toISOString(),
                    'timeMax': now.toISOString(),
                    'privateExtendedProperty': 'autoPunch=pending', // 'pending'状態の予定のみ取得
                    'singleEvents': true,
                });

                const events = response.result.items;
                if (events.length > 0) {
                    console.log(`${events.length}件の自動打刻対象の予定が見つかりました。`);
                    for (const event of events) {
                        await createPunchFromEvent(event);
                        await markEventAsPunched(event.id);
                    }
                }
            } catch (error) {
                console.error("自動打刻チェック中にエラー:", error);
            }
        }

        // --- 予定から打刻データを作成して保存 ---
        async function createPunchFromEvent(event) {
            const projectId = event.extendedProperties.private.projectId;
            if (!projectId) return; // プロジェクトがなければスキップ

            const startTime = new Date(event.start.dateTime);
            const endTime = new Date(event.end.dateTime);

            try {
                await addDoc(collection(db, `users/${currentUser.uid}/punches`), {
                    userId: currentUser.uid,
                    type: 'work',
                    projectId: projectId,
                    startTime: Timestamp.fromDate(startTime),
                    endTime: Timestamp.fromDate(endTime),
                    memo: `[自動打刻] ${event.summary}`,
                    createdAt: serverTimestamp()
                });
                console.log(`打刻を記録しました: ${event.summary}`);
            } catch (error) {
                console.error("自動打刻のFirestoreへの保存に失敗:", error);
            }
        }
        
        // --- 予定を処理済みに更新 ---
        async function markEventAsPunched(eventId) {
            try {
                await gapi.client.calendar.events.patch({
                    calendarId: 'primary',
                    eventId: eventId,
                    resource: {
                        extendedProperties: {
                            private: {
                                autoPunch: 'done'
                            }
                        }
                    }
                });
                console.log(`予定ID: ${eventId} を処理済みに更新しました。`);
            } catch (error) {
                console.error("予定の更新に失敗:", error);
            }
        }
        
        // --- プロジェクト読み込み（モーダル用） ---
        async function loadProjects() {
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            projects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const select = document.getElementById('event-project-select');
            select.innerHTML = '<option value="">プロジェクトを選択（任意）</option>'; // 初期化
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `[${p.code}] ${p.name}`;
                select.appendChild(option);
            });
        }

    </script>
</body>
</html>
