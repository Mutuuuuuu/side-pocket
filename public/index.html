<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>打刻 - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <div id="header-placeholder"></div>

        <main class="w-full max-w-md mx-auto">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header>
                    <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800">打刻システム</h2>
                    <p id="realtime-clock" class="text-xl sm:text-2xl text-center text-gray-500 mt-2 font-mono"></p>
                </header>

                <div class="space-y-4">
                    <div>
                        <label for="projectCode" class="block text-sm font-medium text-gray-700">プロジェクト:</label>
                        <select id="projectCode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-main focus:border-main">
                            <option value="">プロジェクトを選択してください</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clockInBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200">出勤</button>
                        <button id="clockOutBtn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200" disabled>退勤</button>
                    </div>
                </div>

                <div id="status" class="text-center h-5 mt-4 text-sm"></div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">最終打刻:</h3>
                    <p id="lastPunchInfo" class="text-gray-600 text-sm">
                        <span id="lastPunchType"></span> 
                        <span id="lastPunchTime" class="font-mono"></span>
                        <span id="lastPunchProject"></span>
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, limit, addDoc, updateDoc, doc, getDocs, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // firebaseConfig と __initial_auth_token を shared.js からインポートするように戻す
        import { firebaseConfig, __initial_auth_token, showStatus } from './shared.js'; 

        // Firebaseの初期化
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentPunchId = null; // 現在の打刻ドキュメントID
        let currentPunchType = null; // 'clockIn' or 'clockOut'
        let currentPunchStartTime = null; // 打刻開始時刻 (Timestampオブジェクト)

        const projectCodeSelect = document.getElementById('projectCode');
        const clockInBtn = document.getElementById('clockInBtn');
        const clockOutBtn = document.getElementById('clockOutBtn');
        const lastPunchInfo = document.getElementById('lastPunchInfo');
        const lastPunchTypeSpan = document.getElementById('lastPunchType');
        const lastPunchTimeSpan = document.getElementById('lastPunchTime');
        const lastPunchProjectSpan = document.getElementById('lastPunchProject');
        const realtimeClock = document.getElementById('realtime-clock');

        // リアルタイム時計の更新
        function updateClock() {
            const now = new Date();
            realtimeClock.textContent = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateClock, 1000); // 1秒ごとに更新

        // ページ初期化
        document.addEventListener('DOMContentLoaded', () => {
            updateClock(); // 初回表示
            // Firebase認証状態の監視
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    console.log("Firebase User:", currentUser.uid);
                    showStatus("認証済みユーザー: " + currentUser.email, false, 'status');
                    listenToActiveProjects(); // アクティブなプロジェクトを購読
                    listenToLastPunch(); // 最終打刻を購読
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                } else {
                    currentUser = null;
                    console.log("No Firebase user. Attempting anonymous sign-in or custom token sign-in.");
                    showStatus("認証していません。匿名でサインインします。", false, 'status');
                    try {
                        // Canvas環境で提供されるカスタムトークンがあれば使用
                        // __initial_auth_token は shared.js からインポートされる
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Signed in with custom token.");
                        } else {
                            // それ以外の場合は匿名でサインイン
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        showStatus("認証に失敗しました: " + error.message, true, 'status');
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('app-container').style.display = 'block';
                    }
                }
            });
        });

        // ボタンの活性/非活性を制御
        function setButtonsDisabled(isClockedIn) {
            if (isClockedIn) {
                clockInBtn.disabled = true;
                clockOutBtn.disabled = false;
            } else {
                clockInBtn.disabled = false;
                clockOutBtn.disabled = true;
            }
        }

        // 最終打刻のリアルタイム監視
        function listenToLastPunch() {
            if (!currentUser) return;

            const q = query(
                collection(db, "timestamps"),
                where("userId", "==", currentUser.uid),
                orderBy("clockInTime", "desc"), // 最新の打刻を取得
                limit(1)
            );

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    // 最終打刻がない場合
                    lastPunchInfo.textContent = "まだ打刻がありません。";
                    currentPunchId = null;
                    currentPunchType = null;
                    currentPunchStartTime = null;
                    setButtonsDisabled(false); // 出勤ボタンを有効化
                    projectCodeSelect.disabled = false; // プロジェクト選択を有効化
                    console.log("No last punch found. Ready to clock in.");
                } else {
                    const lastPunch = snapshot.docs[0].data();
                    currentPunchId = snapshot.docs[0].id; // ドキュメントIDを保存
                    currentPunchStartTime = lastPunch.clockInTime; // 開始時刻を保存

                    const clockInTime = lastPunch.clockInTime.toDate();
                    const projectDisplayName = lastPunch.projectName || lastPunch.projectCode || '未選択';

                    if (lastPunch.clockOutTime) {
                        // 退勤済みの場合
                        currentPunchType = 'clockOut';
                        const clockOutTime = lastPunch.clockOutTime.toDate();
                        lastPunchTypeSpan.textContent = "退勤:";
                        lastPunchTimeSpan.textContent = clockOutTime.toLocaleDateString('ja-JP') + ' ' + clockOutTime.toLocaleTimeString('ja-JP');
                        lastPunchProjectSpan.textContent = ` (${projectDisplayName})`;
                        setButtonsDisabled(false); // 出勤ボタンを有効化
                        projectCodeSelect.disabled = false; // プロジェクト選択を有効化
                        console.log("Last punch is clock-out. Ready to clock in again.");
                    } else {
                        // 出勤済みで退勤がまだの場合
                        currentPunchType = 'clockIn';
                        lastPunchTypeSpan.textContent = "出勤中:";
                        lastPunchTimeSpan.textContent = clockInTime.toLocaleDateString('ja-JP') + ' ' + clockInTime.toLocaleTimeString('ja-JP');
                        lastPunchProjectSpan.textContent = ` (${projectDisplayName})`;
                        setButtonsDisabled(true); // 退勤ボタンを有効化
                        projectCodeSelect.value = lastPunch.projectCode || ''; // 最終打刻のプロジェクトを選択状態に
                        projectCodeSelect.disabled = true; // プロジェクト選択を無効化
                        console.log("Last punch is clock-in. Ready to clock out.");
                    }
                }
                showStatus("", false, 'status'); // ステータスをクリア
            }, (error) => {
                console.error("Error listening to last punch:", error);
                showStatus("最終打刻の読み込みに失敗しました: " + error.message, true, 'status');
            });
        }

        // アクティブなプロジェクトのリアルタイム監視
        function listenToActiveProjects() {
            if (!currentUser) return;
            // 'Active' ステータスのプロジェクトをコード順で取得
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("status", "==", "Active"), orderBy("code"));
            onSnapshot(q, (querySnapshot) => {
                const projects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProjectDropdown(projects);
            }, (error) => {
                console.error("Error listening to active projects:", error);
                showStatus("プロジェクトの読み込みに失敗しました: " + error.message, true, 'status');
            });
        }

        // プロジェクト選択ドロップダウンの更新
        function updateProjectDropdown(projects) {
            const select = document.getElementById('projectCode');
            const currentValue = select.value; // 現在選択されている値を保持
            select.innerHTML = '<option value="">プロジェクトを選択してください</option>'; // オプションをクリア
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.code;
                option.textContent = `${p.code}: ${p.name}`;
                option.dataset.name = p.name; // プロジェクト名をデータ属性に保存
                select.appendChild(option);
            });
            // 以前選択されていた値があれば再設定
            if (currentValue && projects.some(p => p.code === currentValue)) {
                select.value = currentValue;
            } else {
                select.value = ""; // なければデフォルトに戻す
            }
        }

        // 出勤打刻
        clockInBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showStatus("ユーザーが認証されていません。", true, 'status');
                return;
            }
            if (currentPunchType === 'clockIn') {
                showStatus("既に出勤中です。", true, 'status');
                return;
            }

            const selectedProjectCode = projectCodeSelect.value;
            if (!selectedProjectCode) {
                showStatus("プロジェクトを選択してください。", true, 'status');
                return;
            }
            const selectedProjectName = projectCodeSelect.options[projectCodeSelect.selectedIndex]?.dataset.name || selectedProjectCode;

            showStatus("出勤打刻中...", false, 'status');
            try {
                const now = Timestamp.now();
                const docRef = await addDoc(collection(db, "timestamps"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    projectCode: selectedProjectCode,
                    projectName: selectedProjectName,
                    clockInTime: now,
                    createdAt: now
                });
                console.log("Clock-in successful with ID:", docRef.id);
                showStatus("出勤しました！", false, 'status');
                // onSnapshotが最終打刻を更新するので、ここではUI更新は不要
            } catch (error) {
                console.error("Error clocking in:", error);
                showStatus("出勤打刻に失敗しました: " + error.message, true, 'status');
            }
        });

        // 退勤打刻
        clockOutBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showStatus("ユーザーが認証されていません。", true, 'status');
                return;
            }
            if (currentPunchType !== 'clockIn' || !currentPunchId) {
                showStatus("出勤していません。", true, 'status');
                return;
            }

            showStatus("退勤打刻中...", false, 'status');
            try {
                const now = Timestamp.now();
                const durationHours = (now.toDate().getTime() - currentPunchStartTime.toDate().getTime()) / 3600000; // ミリ秒を時間に変換

                const timestampRef = doc(db, "timestamps", currentPunchId);
                await updateDoc(timestampRef, {
                    clockOutTime: now,
                    durationHours: parseFloat(durationHours.toFixed(2)), // 小数点以下2桁に丸める
                    updatedAt: now // 更新日時を追加
                });
                console.log("Clock-out successful for ID:", currentPunchId);
                showStatus("退勤しました！", false, 'status');
                // onSnapshotが最終打刻を更新するので、ここではUI更新は不要
            } catch (error) {
                console.error("Error clocking out:", error);
                showStatus("退勤打刻に失敗しました: " + error.message, true, 'status');
            }
        });

    </script>
</body>
</html>
