<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>打刻システム - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <!-- ヘッダーを読み込むためのプレースホルダー -->
        <div id="header-placeholder"></div>

        <main class="w-full max-w-lg mx-auto"> <!-- mx-auto を追加して中央寄せにする -->
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-4">打刻システム</h2>

                <div class="text-center text-4xl font-bold text-main-dark mb-6" id="current-time">
                    00:00:00
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="project-select" class="block text-sm font-medium text-gray-700">プロジェクト:</label>
                        <select id="project-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">プロジェクトを選択してください</option>
                        </select>
                    </div>

                    <div class="flex justify-center space-x-4">
                        <button id="clock-in-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-md shadow-md transition duration-200 text-lg">
                            出勤
                        </button>
                        <button id="clock-out-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-md shadow-md transition duration-200 text-lg" disabled>
                            退勤
                        </button>
                    </div>

                    <div id="status-message" class="text-center h-5 mt-4 text-sm font-medium"></div>

                    <div class="text-center text-sm text-gray-600 mt-6">
                        <p>最終打刻: <span id="last-clock-in-out">---</span></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    //<script type="module">
       // ヘッダーを動的に読み込むスクリプト
         document.addEventListener('DOMContentLoaded', function() {
            fetch('_header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-placeholder').innerHTML = data;
                })
                .catch(error => console.error('Error loading header:', error));
        });

        import { collection, query, where, orderBy, limit, onSnapshot, addDoc, updateDoc, doc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js'; // shared.jsから関数をインポート

        let currentUser = null;
        let currentTimestampId = null; // 現在の打刻IDを保持
        let clockInTime = null; // 出勤時間を保持
        let projectsData = []; // プロジェクトデータを保持

        // DOM要素の取得
        const currentTimeElement = document.getElementById('current-time');
        const projectSelect = document.getElementById('project-select');
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const statusMessageElement = document.getElementById('status-message');
        const lastClockInOutElement = document.getElementById('last-clock-in-out');

        /**
         * Firebase認証完了後に呼び出されるメインのセットアップ関数
         * @param {object} user - Firebase認証ユーザーオブジェクト
         */
        async function setupIndexPage(user) {
            currentUser = user;
            if (!currentUser) {
                showStatus("ユーザーが認証されていません。", true, 'status-message');
                return;
            }

            // 現在時刻を更新
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000); // 1秒ごとに更新

            // イベントリスナーの設定
            clockInBtn.addEventListener('click', handleClockIn);
            clockOutBtn.addEventListener('click', handleClockOut);

            // プロジェクトと打刻データのリアルタイム購読を開始
            listenToProjects();
            listenToLatestTimestamp();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        /**
         * 現在時刻を更新する
         */
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTimeElement.textContent = `${hours}:${minutes}:${seconds}`;
        }

        /**
         * プロジェクトデータをFirestoreからリアルタイムで購読する
         */
        function listenToProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), orderBy("code"));
            onSnapshot(q, (snapshot) => {
                projectsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateProjectSelect();
            }, (error) => {
                console.error("Error listening to projects:", error);
                showStatus("プロジェクトの読み込みに失敗しました。", true, 'status-message');
            });
        }

        /**
         * プロジェクト選択ドロップダウンを更新する
         */
        function populateProjectSelect() {
            projectSelect.innerHTML = '<option value="">プロジェクトを選択してください</option>';
            projectsData.forEach(project => {
                const option = document.createElement('option');
                option.value = project.code;
                option.textContent = `${project.code}: ${project.name}`;
                projectSelect.appendChild(option);
            });
        }

        /**
         * 最新の打刻データをFirestoreからリアルタイムで購読する
         */
        function listenToLatestTimestamp() {
            if (!currentUser) return;
            const q = query(
                collection(db, "timestamps"),
                where("userId", "==", currentUser.uid),
                orderBy("clockInTime", "desc"),
                limit(1)
            );
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const latestTimestamp = snapshot.docs[0].data();
                    currentTimestampId = snapshot.docs[0].id;

                    if (latestTimestamp.clockOutTime === null) {
                        // 出勤済みで退勤がまだの場合
                        clockInTime = latestTimestamp.clockInTime.toDate();
                        clockInBtn.disabled = true;
                        clockOutBtn.disabled = false;
                        projectSelect.value = latestTimestamp.projectCode; // 選択中のプロジェクトをセット
                        projectSelect.disabled = true; // プロジェクト選択を無効化
                        showStatus(`現在稼働中です。 (${latestTimestamp.projectCode})`, false, 'status-message');
                    } else {
                        // 退勤済みの場合
                        clockInTime = null;
                        currentTimestampId = null;
                        clockInBtn.disabled = false;
                        clockOutBtn.disabled = true;
                        projectSelect.value = ''; // プロジェクト選択をリセット
                        projectSelect.disabled = false; // プロジェクト選択を有効化
                        showStatus("打刻されていません。", false, 'status-message');
                    }
                    displayLastClockInOut(latestTimestamp);
                } else {
                    // 打刻データが全くない場合
                    clockInTime = null;
                    currentTimestampId = null;
                    clockInBtn.disabled = false;
                    clockOutBtn.disabled = true;
                    projectSelect.value = '';
                    projectSelect.disabled = false;
                    showStatus("打刻されていません。", false, 'status-message');
                    lastClockInOutElement.textContent = '---';
                }
            }, (error) => {
                console.error("Error listening to latest timestamp:", error);
                showStatus("打刻情報の読み込みに失敗しました。", true, 'status-message');
            });
        }

        /**
         * 最終打刻情報を表示する
         * @param {object} timestamp - 最新の打刻データ
         */
        function displayLastClockInOut(timestamp) {
            const clockInDate = timestamp.clockInTime.toDate();
            const clockOutDate = timestamp.clockOutTime ? timestamp.clockOutTime.toDate() : null;
            const project = projectsData.find(p => p.code === timestamp.projectCode);
            const projectName = project ? project.name : '不明なプロジェクト';

            const formatDate = (date) => {
                if (!date) return '---';
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            };

            const inTimeFormatted = formatDate(clockInDate);
            let displayString = '';

            if (clockOutDate) {
                const outTimeFormatted = formatDate(clockOutDate);
                displayString = `${projectName}: ${inTimeFormatted} - ${outTimeFormatted} (退勤)`;
            } else {
                displayString = `${projectName}: ${inTimeFormatted} (出勤中)`;
            }
            lastClockInOutElement.textContent = displayString;
        }

        /**
         * 出勤ボタンのハンドラー
         */
        async function handleClockIn() {
            const selectedProjectCode = projectSelect.value;
            if (!selectedProjectCode) {
                showStatus("プロジェクトを選択してください。", true, 'status-message');
                return;
            }

            if (clockInTime) {
                showStatus("既に稼働中です。", true, 'status-message');
                return;
            }

            showStatus("出勤を記録中...", false, 'status-message');
            try {
                const newTimestamp = {
                    userId: currentUser.uid,
                    projectCode: selectedProjectCode,
                    clockInTime: Timestamp.now(),
                    clockOutTime: null,
                    durationHours: 0,
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                };
                await addDoc(collection(db, "timestamps"), newTimestamp);
                showStatus("出勤しました！", false, 'status-message');
            } catch (error) {
                console.error("Error clocking in:", error);
                showStatus("出勤記録に失敗しました: " + error.message, true, 'status-message');
            }
        }

        /**
         * 退勤ボタンのハンドラー
         */
        async function handleClockOut() {
            if (!currentTimestampId || !clockInTime) {
                showStatus("まだ出勤していません。", true, 'status-message');
                return;
            }

            showStatus("退勤を記録中...", false, 'status-message');
            try {
                const clockOutDate = new Date();
                const durationHours = (clockOutDate.getTime() - clockInTime.getTime()) / (1000 * 60 * 60); // ミリ秒を時間に変換

                const timestampRef = doc(db, "timestamps", currentTimestampId);
                await updateDoc(timestampRef, {
                    clockOutTime: Timestamp.now(),
                    durationHours: durationHours,
                    updatedAt: Timestamp.now()
                });
                showStatus("退勤しました！", false, 'status-message');
            } catch (error) {
                console.error("Error clocking out:", error);
                showStatus("退勤記録に失敗しました: " + error.message, true, 'status-message');
            }
        }

        // 共通の初期化処理を呼び出し、認証完了後に打刻ページの処理を実行
        initializePage(setupIndexPage);
    </script>
</body>
</html>
