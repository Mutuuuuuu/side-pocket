<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <title>Firebase版 打刻アプリ</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='45' fill='white' stroke='black' stroke-width='5'/%3e%3cpath d='M50 20 V50 H75' fill='none' stroke='black' stroke-width='5' %3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google API Client Libraries -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .tab-button.active { border-color: #3B82F6; color: #3B82F6; background-color: #EFF6FF; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* モーダル用のスタイル */
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">打刻システム</h1>
        <div class="flex items-center space-x-4">
            <div id="user-info" class="text-right hidden">
                <p id="user-name" class="font-semibold"></p>
                <p id="user-email" class="text-sm text-gray-500"></p>
            </div>
            <img id="user-icon" class="w-12 h-12 rounded-full hidden" src="https://placehold.co/100x100/ccc/fff?text=User">
            <div class="relative">
                <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
                <div id="dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20 hidden">
                    <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">プロフィール管理</a>
                    <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ログアウト</button>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 md:p-8">
        <!-- Loading Indicator -->
        <div id="loading" class="flex justify-center items-center h-64">
            <div class="loader"></div>
            <p class="ml-4 text-lg">データを読み込んでいます...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="main-content" class="hidden">
            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="tab-punch">打刻</button>
                    <button class="tab-button" data-tab="tab-calendar">カレンダー連携</button>
                    <button class="tab-button" data-tab="tab-report">月次レポート</button>
                    <button class="tab-button" data-tab="tab-projects">プロジェクト管理</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-punch" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow space-y-4 max-w-2xl mx-auto">
                    <div class="text-center">
                        <div id="mainTimer" class="text-6xl font-mono bg-gray-900 text-white rounded-lg py-4">00:00:00</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="startWorkBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg">出勤</button>
                        <button id="endWorkBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>退勤</button>
                    </div>
                    <div class="pt-4 space-y-2">
                        <label for="projectSelectPunch" class="block font-medium text-gray-700">プロジェクト</label>
                        <select id="projectSelectPunch" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div class="space-y-2">
                        <label for="memoInput" class="block font-medium text-gray-700">メモ</label>
                        <textarea id="memoInput" rows="2" class="w-full p-2 border border-gray-300 rounded-md" placeholder="作業内容などを記録できます"></textarea>
                    </div>
                    <div id="punchMessage" class="text-center text-sm text-gray-500 h-5"></div>
                </div>
            </div>

            <div id="tab-calendar" class="tab-content space-y-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Googleカレンダー連携</h2>
                    <p id="gcal-auth-status" class="text-gray-600 mb-4">ステータス：初期化中...</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="gcal-authorize-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded hidden">Googleと連携する</button>
                        <button id="gcal-signout-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">連携を解除</button>
                        <button id="gcal-load-events-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded hidden">予定を読み込む</button>
                        <button id="gcal-add-event-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded hidden">予定を作成</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-bold mb-2">カレンダーの予定</h3>
                     <div id="calendar-events-container" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">連携後に「予定を読み込む」ボタンを押してください。</p>
                     </div>
                </div>
            </div>

            <div id="tab-report" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow space-y-4">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <h2 class="text-xl font-bold">月次レポート</h2>
                        <div class="flex items-center gap-2">
                            <button id="prevMonthBtn" class="px-3 py-1 border rounded-md">&lt;</button>
                            <input type="month" id="reportMonth" class="p-2 border rounded-md">
                            <button id="nextMonthBtn" class="px-3 py-1 border rounded-md">&gt;</button>
                        </div>
                        <button id="exportPdfBtn" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md">PDFでエクスポート</button>
                    </div>
                    <!-- ★★★ グラフ表示用のCanvasを追加 ★★★ -->
                    <div class="my-4"><canvas id="reportChart"></canvas></div>
                    <div id="reportOutput" class="space-y-4 overflow-x-auto"></div>
                    <div id="reportSummary" class="text-right font-bold text-lg pr-4"></div>
                </div>
            </div>
            <div id="tab-projects" class="tab-content">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow space-y-4">
                        <h2 class="text-xl font-bold">プロジェクト追加</h2>
                        <form id="addProjectForm" class="space-y-3">
                            <input type="text" id="projectCode" placeholder="プロジェクトコード" required class="w-full p-2 border rounded-md">
                            <input type="text" id="projectName" placeholder="プロジェクト名" required class="w-full p-2 border rounded-md">
                            <input type="color" id="projectColor" value="#808080" class="w-full h-10 p-1 border rounded-md">
                            <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">追加</button>
                        </form>
                        <div id="projectManagementStatus" class="text-center h-5"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow space-y-4">
                        <h2 class="text-xl font-bold">プロジェクト一覧</h2>
                        <div id="projectList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="add-event-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <!-- ... (内容は変更なし) ... -->
    </div>
    
    <!-- ★★★ プロジェクト編集用モーダルを追加 ★★★ -->
    <div id="edit-project-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">プロジェクトを編集</h2>
            <form id="editProjectForm">
                <input type="hidden" id="editProjectId">
                <div class="space-y-4">
                    <div>
                        <label for="editProjectCode" class="block text-sm font-medium text-gray-700">プロジェクトコード</label>
                        <input type="text" id="editProjectCode" required class="mt-1 w-full px-4 py-2 border rounded-md">
                    </div>
                    <div>
                        <label for="editProjectName" class="block text-sm font-medium text-gray-700">プロジェクト名</label>
                        <input type="text" id="editProjectName" required class="mt-1 w-full px-4 py-2 border rounded-md">
                    </div>
                    <div>
                        <label for="editProjectColor" class="block text-sm font-medium text-gray-700">色</label>
                        <input type="color" id="editProjectColor" class="mt-1 w-full h-10 p-1 border rounded-md">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-project" class="px-4 py-2 bg-gray-200 rounded-md">キャンセル</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md">更新</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where, serverTimestamp, Timestamp, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { IPAEXG_FONT_B64 } from './fonts.js';

        const API_KEY = 'AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM';
        const CLIENT_ID = '887116583823-32evpk9fa2m0ondbbco6tv4m1980i7bj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const firebaseConfig = {
            apiKey: "AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM",
            authDomain: "side-pocket-sl.firebaseapp.com",
            projectId: "side-pocket-sl",
            storageBucket: "side-pocket-sl.firebasestorage.app",
            messagingSenderId: "887116583823",
            appId: "1:887116583823:web:5783488bd573f5be4bf1fa",
            measurementId: "G-QSBDN1TX68"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let projects = [];
        let currentPunchId = null;
        let timerInterval = null;
        let reportData = [];
        let reportChart = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await setupUIForUser(user);
                gapi.load('client', initializeGapiClient);
                setTimeout(() => {
                    try {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID, scope: SCOPES,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) { return; }
                                gapi.client.setToken(tokenResponse);
                                updateGcalUi();
                            },
                        });
                        gisInited = true;
                        updateGcalUi();
                    } catch (e) { console.error("Error initializing Google Identity Services.", e); }
                }, 1000);
            } else { window.location.href = 'login.html'; }
        });

        async function setupUIForUser(user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('user-name').textContent = userData.displayName || '名無しさん';
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-icon').src = userData.photoURL || 'https://placehold.co/100x100/ccc/fff?text=User';
            }
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-icon').classList.remove('hidden');
            
            const projectsQuery = query(collection(db, "projects"), where("ownerId", "==", user.uid));
            onSnapshot(projectsQuery, (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProjectDropdowns();
                displayProjectList();
            });

            await checkForOngoingPunch();
            setupReportMonth();
            setupProjectEditModal();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            setInterval(checkForAutoPunch, 30 * 60 * 1000);
        }

        function showStatus(message, isError, elementId) {
            const elem = document.getElementById(elementId);
            if (elem) {
                elem.textContent = message;
                elem.className = isError ? 'text-red-500 text-center h-5' : 'text-green-500 text-center h-5';
            }
        }

        function updateProjectDropdowns() {
            const punchSelect = document.getElementById('projectSelectPunch');
            const eventSelect = document.getElementById('event-project-select');
            [punchSelect, eventSelect].forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                if (select.id === 'event-project-select') {
                    select.innerHTML = '<option value="">プロジェクトを選択（任意）</option>';
                } else { select.innerHTML = '<option value="">プロジェクトを選択</option>'; }
                projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `[${p.code}] ${p.name}`;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        }

        // --- 打刻機能 ---
        const startWorkBtn = document.getElementById('startWorkBtn');
        const endWorkBtn = document.getElementById('endWorkBtn');
        const timerDiv = document.getElementById('mainTimer');

        async function checkForOngoingPunch() {
            const q = query(collection(db, `users/${currentUser.uid}/punches`), where("endTime", "==", null));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const punchDoc = snapshot.docs[0];
                currentPunchId = punchDoc.id;
                const punchData = punchDoc.data();
                const startTime = punchData.startTime.toDate();
                startTimer(startTime);
                startWorkBtn.disabled = true;
                endWorkBtn.disabled = false;
                document.getElementById('projectSelectPunch').value = punchData.projectId;
                document.getElementById('memoInput').value = punchData.memo || '';
            } else {
                startWorkBtn.disabled = false;
                endWorkBtn.disabled = true;
                timerDiv.textContent = "00:00:00";
                if(timerInterval) clearInterval(timerInterval);
            }
        }

        function startTimer(startTime) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = new Date() - startTime;
                const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
                const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
                const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                timerDiv.textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        startWorkBtn.addEventListener('click', async () => {
            const projectId = document.getElementById('projectSelectPunch').value;
            if (!projectId) {
                showStatus("プロジェクトを選択してください。", true, 'punchMessage');
                return;
            }
            showStatus("", false, 'punchMessage');
            try {
                const punchRef = await addDoc(collection(db, `users/${currentUser.uid}/punches`), {
                    userId: currentUser.uid, type: 'work', projectId: projectId,
                    startTime: serverTimestamp(), endTime: null,
                    memo: document.getElementById('memoInput').value
                });
                currentPunchId = punchRef.id;
                await checkForOngoingPunch();
            } catch (error) { showStatus("出勤処理に失敗しました。", true, 'punchMessage'); }
        });

        endWorkBtn.addEventListener('click', async () => {
            if (!currentPunchId) return;
            try {
                const punchDocRef = doc(db, `users/${currentUser.uid}/punches`, currentPunchId);
                await setDoc(punchDocRef, { 
                    endTime: serverTimestamp(), memo: document.getElementById('memoInput').value 
                }, { merge: true });
                clearInterval(timerInterval);
                currentPunchId = null;
                document.getElementById('memoInput').value = '';
                await checkForOngoingPunch();
                showStatus("退勤しました。", false, 'punchMessage');
            } catch (error) { showStatus("退勤処理に失敗しました。", true, 'punchMessage'); }
        });

        // --- プロジェクト管理機能 ---
        function displayProjectList() {
            const listContainer = document.getElementById('projectList');
            listContainer.innerHTML = '';
            if (projects.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">プロジェクトがありません。</p>';
                return;
            }
            projects.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 border rounded hover:bg-gray-50';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-4 h-4 rounded-full" style="background-color: ${p.color || '#808080'};"></span>
                        <span>[${p.code}] ${p.name}</span>
                    </div>
                    <button data-id="${p.id}" class="edit-project-btn text-sm text-blue-500 hover:underline">編集</button>
                `;
                listContainer.appendChild(div);
            });
            document.querySelectorAll('.edit-project-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openProjectEditModal(e.target.dataset.id));
            });
        }

        document.getElementById('addProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const codeInput = document.getElementById('projectCode');
            const nameInput = document.getElementById('projectName');
            const colorInput = document.getElementById('projectColor');
            const code = codeInput.value.trim();
            const name = nameInput.value.trim();
            if (!code || !name) {
                showStatus("エラー: コードと名前は必須です。", true, 'projectManagementStatus');
                return;
            }
            showStatus("追加しています...", false, 'projectManagementStatus');
            try {
                const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) { throw new Error("同じプロジェクトコードが既に存在します。"); }
                
                await addDoc(collection(db, "projects"), {
                    code: code, name: name, color: colorInput.value, ownerId: currentUser.uid
                });
                showStatus("プロジェクトを追加しました。", false, 'projectManagementStatus');
                codeInput.value = ''; nameInput.value = '';
            } catch (error) { showStatus(`追加エラー: ${error.message}`, true, 'projectManagementStatus'); }
        });
        
        // ★★★ プロジェクト編集モーダルのロジックを追加 ★★★
        function setupProjectEditModal() {
            const modal = document.getElementById('edit-project-modal');
            document.getElementById('cancel-edit-project').addEventListener('click', () => modal.classList.add('hidden'));
            document.getElementById('editProjectForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const projectId = document.getElementById('editProjectId').value;
                const projectRef = doc(db, "projects", projectId);
                try {
                    await updateDoc(projectRef, {
                        code: document.getElementById('editProjectCode').value,
                        name: document.getElementById('editProjectName').value,
                        color: document.getElementById('editProjectColor').value,
                    });
                    modal.classList.add('hidden');
                } catch(error) {
                    alert('更新に失敗しました: ' + error.message);
                }
            });
        }

        function openProjectEditModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editProjectCode').value = project.code;
            document.getElementById('editProjectName').value = project.name;
            document.getElementById('editProjectColor').value = project.color || '#808080';
            document.getElementById('edit-project-modal').classList.remove('hidden');
        }

        // --- 月次レポート機能 ---
        const reportMonthInput = document.getElementById('reportMonth');
        function setupReportMonth() {
            reportMonthInput.value = new Date().toISOString().slice(0, 7);
            reportMonthInput.addEventListener('change', generateReport);
            document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonth(1));
            document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
            generateReport();
        }

        function changeMonth(offset) {
            const [year, month] = reportMonthInput.value.split('-').map(Number);
            reportMonthInput.value = new Date(year, month - 1 + offset, 1).toISOString().slice(0, 7);
            generateReport();
        }

        async function generateReport() {
            const reportMonth = reportMonthInput.value;
            if (!reportMonth) return;
            
            const [year, month] = reportMonth.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 1);

            const q = query(collection(db, `users/${currentUser.uid}/punches`),
                where("startTime", ">=", startDate), where("startTime", "<", endDate));
            
            const snapshot = await getDocs(q);
            reportData = snapshot.docs
                .map(doc => ({id: doc.id, ...doc.data()}))
                .filter(p => p.startTime && p.endTime)
                .sort((a, b) => a.startTime.toMillis() - b.startTime.toMillis());
            
            renderReportTable();
            renderReportChart(); // ★★★ グラフ描画関数を呼び出す ★★★
        }
        
        function renderReportTable() {
            const outputDiv = document.getElementById('reportOutput');
            outputDiv.innerHTML = '';
            if (reportData.length === 0) {
                outputDiv.innerHTML = '<p class="text-center py-4">この月の打刻データはありません。</p>';
                document.getElementById('reportSummary').textContent = '';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-left border-collapse';
            table.innerHTML = `<thead><tr>
                <th class="border p-2">日付</th><th class="border p-2">プロジェクト</th>
                <th class="border p-2">開始</th><th class="border p-2">終了</th>
                <th class="border p-2">勤務時間</th><th class="border p-2">メモ</th>
            </tr></thead>`;
            const tbody = document.createElement('tbody');
            let totalMillis = 0;
            reportData.forEach(p => {
                const start = p.startTime.toDate();
                const end = p.endTime.toDate();
                const duration = end - start;
                totalMillis += duration;
                const project = projects.find(proj => proj.id === p.projectId);
                tbody.innerHTML += `
                    <tr>
                        <td class="border p-2">${start.toLocaleDateString()}</td>
                        <td class="border p-2"><div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${project?.color || '#808080'};"></span>
                            <span>${project?.name || 'N/A'}</span>
                        </div></td>
                        <td class="border p-2">${start.toLocaleTimeString()}</td>
                        <td class="border p-2">${end.toLocaleTimeString()}</td>
                        <td class="border p-2">${new Date(duration).toISOString().substr(11, 8)}</td>
                        <td class="border p-2">${p.memo || ''}</td>
                    </tr>`;
            });
            table.appendChild(tbody);
            outputDiv.appendChild(table);
            const totalHours = Math.floor(totalMillis / 3600000);
            const totalMinutes = Math.floor((totalMillis % 3600000) / 60000);
            document.getElementById('reportSummary').textContent = `合計勤務時間: ${totalHours}時間 ${totalMinutes}分`;
        }

        // ★★★ グラフ描画ロジックを追加 ★★★
        function renderReportChart() {
            const ctx = document.getElementById('reportChart').getContext('2d');
            if (reportChart) {
                reportChart.destroy();
            }
            if (reportData.length === 0) {
                return;
            }

            const dailyData = {};
            reportData.forEach(p => {
                const date = p.startTime.toDate().getDate();
                const duration = p.endTime.toDate() - p.startTime.toDate();
                dailyData[date] = (dailyData[date] || 0) + duration;
            });

            const labels = Object.keys(dailyData).map(d => `${d}日`);
            const data = Object.values(dailyData).map(ms => (ms / (1000 * 60 * 60)).toFixed(2));

            reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '勤務時間 (時間)',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        function exportPDF() {
            if (reportData.length === 0) { alert("エクスポートするデータがありません。"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.addFileToVFS("ipaexg.ttf", IPAEXG_FONT_B64);
            doc.addFont("ipaexg.ttf", "ipaexg", "normal");
            doc.setFont("ipaexg");
            const reportMonth = reportMonthInput.value;
            const summaryText = document.getElementById('reportSummary').textContent;
            doc.text(`${reportMonth} 勤務レポート`, 14, 16);
            doc.text(summaryText, 14, 24);
            const head = [['日付', 'プロジェクト', '開始', '終了', '勤務時間', 'メモ']];
            const body = reportData.map(p => {
                const start = p.startTime.toDate();
                const end = p.endTime.toDate();
                const duration = end - start;
                const projectName = projects.find(proj => proj.id === p.projectId)?.name || 'N/A';
                return [
                    start.toLocaleDateString(), projectName, start.toLocaleTimeString(),
                    end.toLocaleTimeString(), new Date(duration).toISOString().substr(11, 8), p.memo || ''
                ];
            });
            doc.autoTable({ head: head, body: body, startY: 30, styles: { font: 'ipaexg', fontStyle: 'normal' } });
            doc.save(`report-${reportMonth}.pdf`);
        }

        // --- Googleカレンダー連携 ---
        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                updateGcalUi();
            } catch (error) {
                document.getElementById('gcal-auth-status').textContent = 'エラー: Google APIの初期化に失敗しました。APIキーが正しいか、またはURLが許可されているか確認してください。';
            }
        }
        function updateGcalUi() {
            if (!gapiInited || !gisInited) return;
            const statusText = document.getElementById('gcal-auth-status');
            const authorizeButton = document.getElementById('gcal-authorize-button');
            const signoutButton = document.getElementById('gcal-signout-button');
            const loadEventsButton = document.getElementById('gcal-load-events-button');
            const addEventButton = document.getElementById('gcal-add-event-button');
            if (gapi.client.getToken() === null) {
                statusText.textContent = 'ステータス：未認証。Googleアカウントと連携してください。';
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                loadEventsButton.classList.add('hidden');
                addEventButton.classList.add('hidden');
            } else {
                statusText.textContent = 'ステータス：連携済みです。';
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                loadEventsButton.classList.remove('hidden');
                addEventButton.classList.remove('hidden');
            }
        }
        document.getElementById('gcal-authorize-button').addEventListener('click', () => { if (tokenClient) tokenClient.requestAccessToken(); });
        document.getElementById('gcal-signout-button').addEventListener('click', () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateGcalUi();
                    document.getElementById('calendar-events-container').innerHTML = '<p class="text-gray-500">連携を解除しました。</p>';
                });
            }
        });
        document.getElementById('gcal-load-events-button').addEventListener('click', listUpcomingEvents);
        async function listUpcomingEvents() {
            const container = document.getElementById('calendar-events-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary', 'timeMin': (new Date()).toISOString(),
                    'showDeleted': false, 'singleEvents': true, 'maxResults': 10, 'orderBy': 'startTime',
                });
                const events = response.result.items;
                if (!events || events.length == 0) { container.innerText = '直近の予定はありません。'; return; }
                container.innerHTML = '';
                events.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const projectInfo = event.extendedProperties?.private?.projectId ? `【${projects.find(p => p.id === event.extendedProperties.private.projectId)?.name || '不明'}】` : '';
                    const eventEl = document.createElement('div');
                    eventEl.className = 'p-2 border rounded bg-gray-50';
                    eventEl.innerHTML = `<p class="font-bold">${event.summary} ${projectInfo}</p><p class="text-sm text-gray-600">${new Date(start).toLocaleString()}</p>`;
                    container.appendChild(eventEl);
                });
            } catch (err) { container.innerText = 'エラー: ' + err.message; }
        }
        document.getElementById('gcal-add-event-button').addEventListener('click', () => {
            document.getElementById('add-event-modal').classList.remove('hidden');
        });
        document.getElementById('cancel-add-event').addEventListener('click', () => {
            document.getElementById('add-event-modal').classList.add('hidden');
        });
        document.getElementById('add-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const event = {
                'summary': document.getElementById('event-summary').value,
                'description': document.getElementById('event-description').value,
                'start': { 'dateTime': new Date(document.getElementById('event-start-time').value).toISOString() },
                'end': { 'dateTime': new Date(document.getElementById('event-end-time').value).toISOString() },
                'extendedProperties': { 'private': { 'projectId': document.getElementById('event-project-select').value, 'autoPunch': 'pending' } }
            };
            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                alert('予定を作成しました！');
                document.getElementById('add-event-modal').classList.add('hidden');
                listUpcomingEvents();
            } catch (error) { alert('予定の作成に失敗しました: ' + error.message); }
        });
        async function checkForAutoPunch() {
            if (gapi.client.getToken() === null) return;
            const now = new Date(); const threeDaysAgo = new Date(); threeDaysAgo.setDate(now.getDate() - 3);
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary', 'timeMin': threeDaysAgo.toISOString(), 'timeMax': now.toISOString(),
                    'privateExtendedProperty': 'autoPunch=pending', 'singleEvents': true,
                });
                for (const event of response.result.items) {
                    await createPunchFromEvent(event);
                    await markEventAsPunched(event.id);
                }
            } catch (error) { console.error("自動打刻チェック中にエラー:", error); }
        }
        async function createPunchFromEvent(event) {
            const projectId = event.extendedProperties.private.projectId;
            if (!projectId) return;
            try {
                await addDoc(collection(db, `users/${currentUser.uid}/punches`), {
                    userId: currentUser.uid, type: 'work', projectId: projectId,
                    startTime: Timestamp.fromDate(new Date(event.start.dateTime)),
                    endTime: Timestamp.fromDate(new Date(event.end.dateTime)),
                    memo: `[自動打刻] ${event.summary}`, createdAt: serverTimestamp()
                });
            } catch (error) { console.error("自動打刻のFirestoreへの保存に失敗:", error); }
        }
        async function markEventAsPunched(eventId) {
            try {
                await gapi.client.calendar.events.patch({
                    calendarId: 'primary', eventId: eventId,
                    resource: { extendedProperties: { private: { autoPunch: 'done' } } }
                });
            } catch (error) { console.error("予定の更新に失敗:", error); }
        }
        
        // --- その他 ---
        document.querySelectorAll('.tab-button').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        document.getElementById('menu-button').addEventListener('click', () => {
            document.getElementById('dropdown-menu').classList.toggle('hidden');
        });
        document.getElementById('logout-button').addEventListener('click', () => { signOut(auth); });

    </script>
</body>
</html>
