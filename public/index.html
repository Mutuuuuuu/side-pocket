<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <title>Firebase版 打刻アプリ</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='45' fill='white' stroke='black' stroke-width='5'/%3e%3cpath d='M50 20 V50 H75' fill='none' stroke='black' stroke-width='5' %3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google API Client Libraries -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        :root {
            --main-color: #698966;
            --main-color-dark: #5a7d58;
            --main-color-light: #f0f3f0;
        }
        body { font-family: 'Noto Sans JP', sans-serif; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .tab-btn.active { border-color: var(--main-color); color: var(--main-color); }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--main-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom color classes */
        .bg-main { background-color: var(--main-color); }
        .hover\:bg-main-dark:hover { background-color: var(--main-color-dark); }
        .text-main { color: var(--main-color); }
        .border-main { border-color: var(--main-color); }
        .ring-main:focus { ring-color: var(--main-color); }
        .bg-main-light { background-color: var(--main-color-light); }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div>
        <p class="ml-4 text-lg">データを読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <!-- Header -->
        <header class="w-full max-w-4xl mx-auto mb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-700">side pocket</h1>
            <div class="flex items-center gap-3">
                <a href="profile.html" class="flex items-center gap-2 text-sm text-gray-600 hover:text-main no-underline">
                    <img id="user-icon" src="https://placehold.co/32x32/EFEFEF/333333?text=?" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                    <span id="user-display-name"></span>
                </a>
                <div class="relative">
                    <button id="menu-button" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    </button>
                    <div id="dropdown-menu" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-xl z-20 hidden">
                        <button id="menu-calendar" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">カレンダー連携</button>
                        <button id="menu-summary" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">稼働管理</button>
                        <button id="menu-projects" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">プロジェクト管理</button>
                        <div class="border-t border-gray-100"></div>
                        <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">ログアウト</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Views -->
        <main id="clockInView" class="w-full max-w-md mx-auto" style="display: none;">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header>
                    <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800">打刻システム</h2>
                    <p id="realtime-clock" class="text-xl sm:text-2xl text-center text-gray-500 mt-2 font-mono"></p>
                </header>
                <div class="space-y-2">
                    <label for="projectCode" class="text-sm font-medium text-gray-700">プロジェクト</label>
                    <select id="projectCode" class="w-full px-4 py-3 text-base bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 ring-main outline-none">
                        <option value="">プロジェクトを選択してください</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="clockInBtn" class="btn w-full px-6 py-3 text-lg font-semibold text-white bg-main rounded-lg hover:bg-main-dark">出勤</button>
                    <button id="clockOutBtn" class="btn w-full px-6 py-3 text-lg font-semibold text-white bg-slate-500 rounded-lg hover:bg-slate-600">退勤</button>
                </div>
                <div id="status" class="pt-4 text-center font-medium h-10"></div>
            </div>
        </main>

        <main id="summaryView" class="w-full max-w-4xl mx-auto" style="display: none;">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">稼働管理</h2>
                    <button class="btn-back btn w-full sm:w-auto px-6 py-2 text-base font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">戻る</button>
                </header>
                <div class="bg-gray-50 p-4 rounded-lg"><canvas id="monthlyChart"></canvas></div>
                <div>
                    <label for="monthSelector" class="text-sm font-medium text-gray-700">表示月を選択:</label>
                    <select id="monthSelector" class="mt-1 block w-full sm:w-auto p-2 border border-gray-300 rounded-md"></select>
                </div>
                <div id="detailsContainer">
                    <div id="projectTabs" class="border-b border-gray-200"></div>
                    <div id="projectTabContent" class="mt-4"></div>
                </div>
                <div id="summaryStatus" class="pt-2 text-center text-gray-600 font-medium h-8"></div>
            </div>
        </main>

        <main id="projectManagementView" class="w-full max-w-2xl mx-auto" style="display: none;">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">プロジェクト管理</h2>
                    <button class="btn-back btn w-full sm:w-auto px-6 py-2 text-base font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">戻る</button>
                </header>
                <div id="projectManagementStatus" class="text-center font-medium h-8"></div>
                <div class="p-4 border rounded-lg space-y-3">
                    <h3 class="text-lg font-bold">新規プロジェクト追加</h3>
                    <input type="text" id="newProjectCode" placeholder="プロジェクトコード (例: P-001)" class="w-full p-2 border rounded">
                    <input type="text" id="newProjectName" placeholder="プロジェクト名" class="w-full p-2 border rounded">
                    <button id="addProjectBtn" class="btn w-full text-white bg-main hover:bg-main-dark p-2 rounded-lg">追加</button>
                </div>
                <div class="space-y-3">
                    <h3 class="text-lg font-bold">プロジェクト一覧</h3>
                    <div id="projectListContainer" class="space-y-2"></div>
                </div>
            </div>
        </main>

        <main id="calendarView" class="w-full max-w-4xl mx-auto" style="display: none;">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Googleカレンダー連携</h2>
                    <button class="btn-back btn w-full sm:w-auto px-6 py-2 text-base font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">戻る</button>
                </header>
                <div id="gcal-auth-container" class="bg-gray-50 p-4 rounded-lg">
                    <p id="gcal-auth-status" class="text-gray-600 mb-4">ステータス：初期化中...</p>
                    <div class="flex flex-wrap gap-2">
                        <button id="gcal-authorize-button" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded hidden">Googleと連携する</button>
                        <button id="gcal-signout-button" class="btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded hidden">連携を解除</button>
                    </div>
                </div>
                <div id="gcal-controls" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="calendar-select" class="block text-sm font-medium text-gray-700">カレンダーを選択:</label>
                            <select id="calendar-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                        <div>
                            <label for="calendar-month" class="block text-sm font-medium text-gray-700">月を選択:</label>
                            <input type="month" id="calendar-month" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="load-calendar-events-btn" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded">予定を読み込む</button>
                    </div>
                    <div id="calendar-events-container" class="space-y-2 max-h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-gray-500 text-center py-4">カレンダーと月を選択して「予定を読み込む」を押してください。</p>
                    </div>
                    <div id="calendar-action-bar" class="hidden flex justify-end p-4 border-t">
                        <button id="reflect-events-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full md:w-auto">選択した予定を稼働実績に反映</button>
                    </div>
                    <div id="reflect-status" class="text-center h-5"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ★★★ 稼働実績の修正用モーダル ★★★ -->
    <div id="edit-timestamp-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">稼働実績の修正</h2>
            <form id="edit-timestamp-form">
                <input type="hidden" id="edit-timestamp-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-start-time" class="block text-sm font-medium text-gray-700">開始時間</label>
                        <input type="datetime-local" id="edit-start-time" required class="mt-1 w-full px-4 py-2 border rounded-md">
                    </div>
                    <div>
                        <label for="edit-end-time" class="block text-sm font-medium text-gray-700">終了時間</label>
                        <input type="datetime-local" id="edit-end-time" required class="mt-1 w-full px-4 py-2 border rounded-md">
                    </div>
                    <div>
                        <label for="edit-project-select" class="block text-sm font-medium text-gray-700">プロジェクト</label>
                        <select id="edit-project-select" required class="mt-1 w-full px-4 py-2 border rounded-md"></select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-timestamp" class="px-4 py-2 bg-gray-200 rounded-md">キャンセル</button>
                    <button type="submit" class="px-4 py-2 bg-main text-white rounded-md">更新</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, doc, updateDoc, serverTimestamp, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { IPAEXG_FONT_B64 } from './fonts.js';

        const API_KEY = 'AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM';
        const CLIENT_ID = '887116583823-32evpk9fa2m0ondbbco6tv4m1980i7bj.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const firebaseConfig = {
            apiKey: "AIzaSyBuRc0oRFQk-GvVAh_90S9NGAYu5sOkxyM",
            authDomain: "side-pocket-sl.firebaseapp.com",
            projectId: "side-pocket-sl",
            storageBucket: "side-pocket-sl.appspot.com",
            messagingSenderId: "887116583823",
            appId: "1:887116583823:web:5783488bd573f5be4bf1fa",
            measurementId: "G-QSBDN1TX68"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let fullDashboardData = {};
        let monthlyChartInstance = null;
        let projectsUnsubscribe = null;
        let timestampsUnsubscribe = null;
        const projectDataMap = new Map();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('user-display-name').textContent = user.displayName || user.email;
                document.getElementById('user-icon').src = user.photoURL || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.displayName || user.email || '?').charAt(0)}`;
                
                listenToAllProjects();
                showMainView('clockInView');

                gapi.load('client', initializeGapiClient);
                setTimeout(() => {
                    try {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID, scope: SCOPES,
                            callback: (tokenResponse) => {
                                if (tokenResponse.error) { return; }
                                gapi.client.setToken(tokenResponse);
                                updateGcalUi();
                            },
                        });
                        gisInited = true;
                        updateGcalUi();
                    } catch (e) { console.error("Error initializing Google Identity Services.", e); }
                }, 1000);
            } else {
                window.location.href = 'login.html';
            }
        });

        function unsubscribeAllListeners() {
            if (timestampsUnsubscribe) timestampsUnsubscribe();
            timestampsUnsubscribe = null;
        }

        const mainViews = ['clockInView', 'summaryView', 'projectManagementView', 'calendarView'];
        
        function showMainView(viewId) {
            mainViews.forEach(id => {
                document.getElementById(id).style.display = (id === viewId) ? 'block' : 'none';
            });
            unsubscribeAllListeners();
            if (viewId === 'summaryView') {
                listenToTimestamps();
            }
        }

        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');

        menuButton.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        window.addEventListener('click', (e) => {
            if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        document.getElementById('menu-calendar').addEventListener('click', () => {
            showMainView('calendarView');
            dropdownMenu.classList.add('hidden');
        });
        document.getElementById('menu-summary').addEventListener('click', () => {
            showMainView('summaryView');
            dropdownMenu.classList.add('hidden');
        });
        document.getElementById('menu-projects').addEventListener('click', () => {
            showMainView('projectManagementView');
            dropdownMenu.classList.add('hidden');
        });
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (projectsUnsubscribe) projectsUnsubscribe();
            signOut(auth);
        });
        document.querySelectorAll('.btn-back').forEach(btn => btn.addEventListener('click', () => showMainView('clockInView')));
        
        function showStatus(message, isError, elementId) {
            const statusDiv = document.getElementById(elementId);
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `pt-4 text-center font-medium h-10 ${isError ? 'text-red-600' : 'text-green-600'}`;
            }
        }

        function updateClock() { document.getElementById('realtime-clock').textContent = new Date().toLocaleTimeString('ja-JP'); }
        setInterval(updateClock, 1000);

        document.getElementById('clockInBtn').addEventListener('click', () => handleTimestamp('出勤'));
        document.getElementById('clockOutBtn').addEventListener('click', () => handleTimestamp('退勤'));

        async function handleTimestamp(action) {
            const projectCode = document.getElementById('projectCode').value;
            if (!projectCode) {
                showStatus("エラー: プロジェクトを選択してください。", true, 'status');
                return;
            }
            setButtonsDisabled(true);
            showStatus("記録しています...", false, 'status');

            try {
                if (action === "出勤") {
                    const q = query(collection(db, "timestamps"), where("userId", "==", currentUser.uid), where("projectCode", "==", projectCode), where("clockOutTime", "==", null));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) throw new Error("このプロジェクトでは既に出勤済みです。");

                    const projectOption = document.querySelector(`#projectCode option[value="${projectCode}"]`);
                    const projectName = projectOption ? projectOption.dataset.name : projectCode;

                    await addDoc(collection(db, "timestamps"), {
                        userId: currentUser.uid, userEmail: currentUser.email,
                        projectCode: projectCode, projectName: projectName,
                        clockInTime: serverTimestamp(), clockOutTime: null, durationHours: null
                    });
                    showStatus(`成功:「出勤」を記録しました。`, false, 'status');
                } else {
                    const q = query(collection(db, "timestamps"), where("userId", "==", currentUser.uid), where("projectCode", "==", projectCode), where("clockOutTime", "==", null), orderBy("clockInTime", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) throw new Error("対応する出勤記録が見つかりません。");

                    const recordDoc = querySnapshot.docs[0];
                    const clockInTime = recordDoc.data().clockInTime.toDate();
                    const now = new Date();
                    const durationHours = (now.getTime() - clockInTime.getTime()) / 3600000;

                    await updateDoc(doc(db, "timestamps", recordDoc.id), {
                        clockOutTime: now,
                        durationHours: parseFloat(durationHours.toFixed(2))
                    });
                    showStatus(`成功:「退勤」を ${now.toLocaleTimeString('ja-JP')} に記録しました。`, false, 'status');
                }
            } catch (error) {
                showStatus(`エラー: ${error.message}`, true, 'status');
            } finally {
                setButtonsDisabled(false);
            }
        }

        function setButtonsDisabled(disabled) {
            [document.getElementById('clockInBtn'), document.getElementById('clockOutBtn')].forEach(btn => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
            });
        }

        function updateProjectDropdown(projects) {
            const activeProjects = projects.filter(p => p.status === 'Active');
            const optionsHtml = activeProjects.map(p => `<option value="${p.code}">${p.code}: ${p.name}</option>`).join('');

            document.getElementById('projectCode').innerHTML = `<option value="">プロジェクトを選択してください</option>${optionsHtml}`;
            document.getElementById('event-project-select').innerHTML = `<option value="">プロジェクトを選択（任意）</option>${optionsHtml}`;
            document.getElementById('edit-project-select').innerHTML = `<option value="">プロジェクトを選択</option>${optionsHtml}`;
        }

        function getProjectsMapFromLocal() {
            const projectsMap = {};
            projectDataMap.forEach(project => {
                projectsMap[project.code] = { name: project.name, color: project.color || '#698966' };
            });
            return projectsMap;
        }

        function listenToTimestamps() {
            if (!currentUser) return;
            showStatus('データを読み込んでいます...', false, 'summaryStatus');
            if (timestampsUnsubscribe) timestampsUnsubscribe();
            const q = query(collection(db, "timestamps"), where("userId", "==", currentUser.uid), orderBy("clockInTime", "desc"));
            timestampsUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const projectsMap = getProjectsMapFromLocal();
                processDashboardData(records, projectsMap);
                showStatus('', false, 'summaryStatus');
            }, (error) => {
                showStatus(`エラー: ${error.message}`, true, 'summaryStatus');
            });
        }

        function processDashboardData(records, projectsMap) {
            const monthlyData = {};
            records.forEach(record => {
                if (!record.clockInTime) return;
                const clockInTime = record.clockInTime.toDate();
                const yearMonth = `${clockInTime.getFullYear()}-${(clockInTime.getMonth() + 1).toString().padStart(2, '0')}`;
                const projectCode = record.projectCode || '未指定';
                const duration = record.durationHours || 0;
                if (!monthlyData[yearMonth]) monthlyData[yearMonth] = {};
                if (!monthlyData[yearMonth][projectCode]) {
                    const projectName = projectsMap[projectCode]?.name || record.projectName || projectCode;
                    monthlyData[yearMonth][projectCode] = { projectName: projectName, total: 0, details: [] };
                }
                monthlyData[yearMonth][projectCode].total += duration;
                if (record.durationHours !== null) {
                    monthlyData[yearMonth][projectCode].details.push({
                        recordId: record.id, date: clockInTime.toLocaleDateString('ja-JP'),
                        clockIn: clockInTime,
                        clockOut: record.clockOutTime ? record.clockOutTime.toDate() : null,
                        duration: duration.toFixed(2),
                        projectCode: projectCode
                    });
                }
            });

            fullDashboardData = monthlyData;
            const allMonths = Object.keys(monthlyData).sort();
            const allProjects = [...new Set(Object.values(monthlyData).flatMap(month => Object.keys(month)))];
            const datasets = allProjects.map(projectCode => {
                const projectInfo = projectsMap[projectCode] || {};
                const color = projectInfo.color || '#698966';
                const dataPoints = allMonths.map(month => monthlyData[month][projectCode]?.total || 0);
                return { label: `${projectInfo.name || projectCode}`, data: dataPoints, borderColor: color, backgroundColor: color, fill: false };
            });
            renderMonthlyChart({ labels: allMonths, datasets });

            const availableMonths = Object.keys(fullDashboardData).sort().reverse();
            document.getElementById('monthSelector').innerHTML = availableMonths.map(month => `<option value="${month}">${month}</option>`).join('');
            if (availableMonths.length > 0) {
                renderMonthData(availableMonths[0]);
            } else {
                document.getElementById('detailsContainer').innerHTML = '<p class="text-center text-gray-500 py-4">表示できるデータがありません。</p>';
            }
        }

        function renderMonthlyChart(graphData) {
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(ctx, {
                type: 'line', data: graphData,
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: value => value + 'h' } } } }
            });
        }

        document.getElementById('monthSelector').addEventListener('change', (e) => renderMonthData(e.target.value));

        function renderMonthData(month) {
            const dataForMonth = fullDashboardData[month] || {};
            const projects = Object.keys(dataForMonth);
            const tabsContainer = document.getElementById('projectTabs');
            const contentContainer = document.getElementById('projectTabContent');
            if (projects.length === 0) {
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '<p class="text-center text-gray-500 py-4">この月には記録がありません。</p>';
                return;
            }
            tabsContainer.innerHTML = `<nav class="-mb-px flex space-x-4 overflow-x-auto">${projects.map((p, i) => `<button data-project="${p}" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${i===0 ? 'active border-main' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">${dataForMonth[p].projectName}</button>`).join('')}</nav>`;
            contentContainer.innerHTML = projects.map((p, i) => {
                const projectData = dataForMonth[p];
                const totalHours = projectData.total.toFixed(2);
                let detailsHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">出勤</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">退勤</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">時間(h)</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">操作</th>
                    </tr></thead><tbody>
                    ${projectData.details.sort((a, b) => new Date(a.clockIn) - new Date(b.clockIn)).map(d => `<tr>
                        <td class="px-4 py-2 text-sm">${d.clockIn.toLocaleString('ja-JP')}</td>
                        <td class="px-4 py-2 text-sm">${d.clockOut.toLocaleString('ja-JP')}</td>
                        <td class="px-4 py-2 text-sm text-right">${d.duration}</td>
                        <td class="px-4 py-2 text-sm text-center">
                            <button class="edit-timestamp-btn btn text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300" data-record-id="${d.recordId}">修正</button>
                        </td>
                    </tr>`).join('')}
                </tbody></table></div>`;
                return `<div data-content="${p}" class="${i===0 ? '' : 'hidden'}">
                    <div class="flex flex-col sm:flex-row justify-between items-center p-4 bg-main-light rounded-lg gap-4">
                        <h3 class="text-lg font-bold">合計時間: <span class="text-main">${totalHours}</span> 時間</h3>
                        <button data-month="${month}" data-project="${p}" class="download-pdf-btn btn w-full sm:w-auto text-white bg-main hover:bg-main-dark px-4 py-2 rounded-lg">PDF出力</button>
                    </div>
                    <div class="mt-4">${detailsHtml}</div>
                </div>`;
            }).join('');
            tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
                const targetProject = btn.dataset.project;
                tabsContainer.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'border-main');
                    b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    if (b.dataset.project === targetProject) {
                        b.classList.add('active', 'border-main');
                        b.classList.remove('border-transparent', 'text-gray-500');
                    }
                });
                contentContainer.querySelectorAll('[data-content]').forEach(c => c.classList.toggle('hidden', c.dataset.content !== targetProject));
            }));
        }

        document.getElementById('detailsContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('download-pdf-btn')) {
                downloadPdf(e.target.dataset.month, e.target.dataset.project);
            } else if (e.target.classList.contains('edit-timestamp-btn')) {
                openEditTimestampModal(e.target.dataset.recordId);
            }
        });

        function downloadPdf(month, projectCode) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const projectData = fullDashboardData[month]?.[projectCode];
            if (!projectData) return;
            doc.addFileToVFS("ipaexg.ttf", IPAEXG_FONT_B64);
            doc.addFont("ipaexg.ttf", "ipaexg", "normal");
            doc.setFont("ipaexg");
            doc.setFontSize(18);
            doc.text(`${month} 稼働時間報告書`, 14, 22);
            doc.setFontSize(14);
            doc.text(`${projectData.projectName} (${projectCode})`, 14, 32);
            doc.setFontSize(12);
            doc.text(`合計時間: ${projectData.total.toFixed(2)} 時間`, 14, 42);
            const tableColumn = ["日付", "出勤", "退勤", "時間(h)"];
            const tableRows = [];
            projectData.details.sort((a, b) => new Date(a.clockIn) - new Date(b.clockIn)).forEach(detail => {
                const datePart = detail.date.split(' ')[0];
                const clockInTimePart = (detail.clockIn || "").toLocaleString('ja-JP').split(' ')[1] || "";
                const clockOutTimePart = (detail.clockOut || "").toLocaleString('ja-JP').split(' ')[1] || "";
                tableRows.push([datePart, clockInTimePart, clockOutTimePart, detail.duration]);
            });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 50, styles: { font: "ipaexg", fontStyle: 'normal' }, headStyles: { fillColor: [105, 137, 102] }, margin: { top: 10, right: 10, bottom: 10, left: 10 } });
            doc.save(`稼働報告書_${month}_${projectCode}.pdf`);
        }

        function listenToAllProjects() {
            if (!currentUser) return;
            if (projectsUnsubscribe) projectsUnsubscribe();
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), orderBy("code"));
            projectsUnsubscribe = onSnapshot(q, (snapshot) => {
                projectDataMap.clear();
                const projects = snapshot.docs.map(doc => {
                    const project = { id: doc.id, ...doc.data() };
                    projectDataMap.set(project.id, project);
                    return project;
                });
                renderProjectList(projects);
                updateProjectDropdown(projects);
            }, (error) => {
                showStatus("プロジェクトリストの取得に失敗しました。", true, 'projectManagementStatus');
            });
        }

        function renderProjectItem(p) {
            return `<div class="project-item flex justify-between items-center p-3 border-b gap-2 rounded-lg bg-white shadow-sm" data-project-id="${p.id}">
                <input type="color" class="project-color-input p-1 h-10 w-10 block bg-white border border-gray-200 cursor-pointer rounded-lg" value="${p.color || '#698966'}">
                <div class="flex-grow">
                    <div data-field="name" class="font-bold text-gray-800">${p.name}</div>
                    <div class="text-sm text-gray-500">${p.code}</div>
                </div>
                <div class="flex items-center gap-2" data-role="action-buttons">
                    <button class="edit-project-btn btn text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">修正</button>
                    <label class="switch"><input type="checkbox" class="project-status-toggle" ${p.status === 'Active' ? 'checked' : ''}><span class="slider"></span></label>
                </div>
            </div>`;
        }

        function renderProjectList(projects) {
            const container = document.getElementById('projectListContainer');
            if (!container) return;
            if (!projects || projects.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">プロジェクトがありません。</p>';
                return;
            }
            container.innerHTML = projects.map(p => renderProjectItem(p)).join('');
        }

        document.getElementById('projectListContainer').addEventListener('change', (e) => {
            if (e.target.classList.contains('project-color-input') || e.target.classList.contains('project-status-toggle')) {
                handleProjectUpdate(e.target);
            }
        });

        document.getElementById('projectListContainer').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('edit-project-btn')) {
                toggleProjectEdit(target);
            } else if (target.classList.contains('save-project-btn')) {
                saveProjectName(target);
            } else if (target.classList.contains('cancel-project-btn')) {
                cancelProjectEdit(target);
            }
        });

        function toggleProjectEdit(button) {
            const projectItem = button.closest('.project-item');
            const nameDiv = projectItem.querySelector('[data-field="name"]');
            const actionButtonsDiv = projectItem.querySelector('[data-role="action-buttons"]');
            const currentName = nameDiv.textContent;
            nameDiv.innerHTML = `<input type="text" class="project-name-input w-full p-1 border rounded" value="${currentName}">`;
            actionButtonsDiv.innerHTML = `<button class="save-project-btn btn text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">保存</button>
                <button class="cancel-project-btn btn text-sm bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500">取消</button>`;
            projectItem.querySelector('.project-name-input').focus();
        }

        function cancelProjectEdit(button) {
            const projectItem = button.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            const originalProject = projectDataMap.get(projectId);
            if (originalProject) {
                const nameDiv = projectItem.querySelector('[data-field="name"]');
                const actionButtonsDiv = projectItem.querySelector('[data-role="action-buttons"]');
                nameDiv.textContent = originalProject.name;
                actionButtonsDiv.innerHTML = `<button class="edit-project-btn btn text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">修正</button>
                    <label class="switch"><input type="checkbox" class="project-status-toggle" ${originalProject.status === 'Active' ? 'checked' : ''}><span class="slider"></span></label>`;
            }
        }

        async function saveProjectName(button) {
            const projectItem = button.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            const nameInput = projectItem.querySelector('.project-name-input');
            const newName = nameInput.value.trim();
            if (!newName) {
                showStatus('プロジェクト名は必須です。', true, 'projectManagementStatus');
                return;
            }
            showStatus('プロジェクト名を更新しています...', false, 'projectManagementStatus');
            const docRef = doc(db, "projects", projectId);
            try {
                await updateDoc(docRef, { name: newName });
                showStatus('更新しました。', false, 'projectManagementStatus');
                const updatedProject = { ...projectDataMap.get(projectId), name: newName };
                projectDataMap.set(projectId, updatedProject);
                cancelProjectEdit(button);
            } catch (error) {
                showStatus(`更新エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        async function handleProjectUpdate(target) {
            const projectItem = target.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            if (!projectId) return;
            const docRef = doc(db, "projects", projectId);
            try {
                const updateData = {};
                if (target.type === 'checkbox') {
                    updateData.status = target.checked ? 'Active' : 'Inactive';
                    showStatus("ステータスを更新しています...", false, 'projectManagementStatus');
                } else if (target.type === 'color') {
                    updateData.color = target.value;
                    showStatus("色を更新しています...", false, 'projectManagementStatus');
                }
                await updateDoc(docRef, updateData);
                showStatus("更新しました。", false, 'projectManagementStatus');
                const currentProject = projectDataMap.get(projectId);
                projectDataMap.set(projectId, { ...currentProject, ...updateData });
            } catch (error) {
                showStatus(`更新エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        document.getElementById('addProjectBtn').addEventListener('click', async () => {
            if (!currentUser) return;
            const codeInput = document.getElementById('newProjectCode');
            const nameInput = document.getElementById('newProjectName');
            const code = codeInput.value.trim();
            const name = nameInput.value.trim();
            if (!code || !name) {
                showStatus("エラー: コードと名前は必須です。", true, 'projectManagementStatus');
                return;
            }
            showStatus("追加しています...", false, 'projectManagementStatus');
            try {
                const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) throw new Error("同じプロジェクトコードが既に存在します。");
                await addDoc(collection(db, "projects"), {
                    code: code, name: name, status: "Active", color: "#698966", ownerId: currentUser.uid
                });
                showStatus("プロジェクトを追加しました。", false, 'projectManagementStatus');
                codeInput.value = ''; nameInput.value = '';
            } catch (error) {
                showStatus(`追加エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        });

        // --- Google Calendar Integration ---
        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                updateGcalUi();
            } catch (error) {
                document.getElementById('gcal-auth-status').textContent = 'エラー: Google APIの初期化に失敗しました。APIキーが正しいか、またはURLが許可されているか確認してください。';
            }
        }
        function updateGcalUi() {
            if (!gapiInited || !gisInited) return;
            const statusText = document.getElementById('gcal-auth-status');
            const authorizeButton = document.getElementById('gcal-authorize-button');
            const signoutButton = document.getElementById('gcal-signout-button');
            const controls = document.getElementById('gcal-controls');

            if (gapi.client.getToken() === null) {
                statusText.textContent = 'ステータス：未認証。Googleアカウントと連携してください。';
                authorizeButton.classList.remove('hidden');
                signoutButton.classList.add('hidden');
                controls.classList.add('hidden');
            } else {
                statusText.textContent = 'ステータス：連携済みです。';
                authorizeButton.classList.add('hidden');
                signoutButton.classList.remove('hidden');
                controls.classList.remove('hidden');
                loadCalendarList();
            }
        }
        document.getElementById('gcal-authorize-button').addEventListener('click', () => { if (tokenClient) tokenClient.requestAccessToken(); });
        document.getElementById('gcal-signout-button').addEventListener('click', () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateGcalUi();
                });
            }
        });

        async function loadCalendarList() {
            try {
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items;
                const select = document.getElementById('calendar-select');
                select.innerHTML = '';
                calendars.forEach(calendar => {
                    const option = document.createElement('option');
                    option.value = calendar.id;
                    option.textContent = calendar.summary;
                    select.appendChild(option);
                });
                document.getElementById('calendar-month').value = new Date().toISOString().slice(0, 7);
            } catch (err) {
                console.error("カレンダーリストの読み込みに失敗", err);
            }
        }

        document.getElementById('load-calendar-events-btn').addEventListener('click', listCalendarEvents);

        async function listCalendarEvents() {
            const calendarId = document.getElementById('calendar-select').value;
            const month = document.getElementById('calendar-month').value;
            if (!month) {
                alert("月を選択してください。");
                return;
            }
            const [year, monthNum] = month.split('-');
            const timeMin = new Date(year, monthNum - 1, 1).toISOString();
            const timeMax = new Date(year, monthNum, 1).toISOString(); // 最終日ではなく翌月1日を指定

            const container = document.getElementById('calendar-events-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            
            try {
                const [eventsResponse, timestampsSnapshot] = await Promise.all([
                    gapi.client.calendar.events.list({
                        'calendarId': calendarId, 'timeMin': timeMin, 'timeMax': timeMax,
                        'showDeleted': false, 'singleEvents': true, 'orderBy': 'startTime',
                    }),
                    getDocs(query(collection(db, "timestamps"), where("userId", "==", currentUser.uid), where("gCalEventId", "!=", null)))
                ]);

                const registeredEventIds = new Set(timestampsSnapshot.docs.map(doc => doc.data().gCalEventId));
                const events = eventsResponse.result.items;

                document.getElementById('calendar-action-bar').classList.toggle('hidden', events.length === 0);
                if (events.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">この月の予定はありません。</p>';
                    return;
                }
                const projectOptions = Array.from(projectDataMap.values())
                    .filter(p => p.status === 'Active')
                    .map(p => `<option value="${p.code}">${p.code}: ${p.name}</option>`).join('');

                container.innerHTML = events.map(event => {
                    const start = event.start.dateTime ? new Date(event.start.dateTime) : new Date(event.start.date);
                    const end = event.end.dateTime ? new Date(event.end.dateTime) : new Date(event.end.date);
                    if (event.start.date) {
                        end.setDate(end.getDate() - 1);
                    }
                    const isRegistered = registeredEventIds.has(event.id);
                    const eventData = JSON.stringify({
                        id: event.id,
                        summary: event.summary,
                        start: start.toISOString(),
                        end: end.toISOString()
                    });
                    return `<div class="p-2 border-b flex flex-wrap items-center gap-3 ${isRegistered ? 'bg-gray-200' : ''}">
                        <input type="checkbox" class="event-checkbox h-4 w-4 rounded" data-event='${eventData}' ${isRegistered ? 'disabled' : ''}>
                        <div class="flex-grow">
                            <p class="font-bold">${event.summary}</p>
                            <p class="text-sm text-gray-600">${start.toLocaleString()} - ${end.toLocaleString()}</p>
                        </div>
                        ${isRegistered 
                            ? `<span class="text-sm font-bold text-green-600">登録済</span>`
                            : `<select class="event-project-select mt-1 md:mt-0 p-1 border border-gray-300 rounded-md text-sm">
                                <option value="">プロジェクト未選択</option>
                                ${projectOptions}
                               </select>`
                        }
                    </div>`;
                }).join('');
            } catch (err) {
                container.innerText = 'エラー: ' + err.message;
            }
        }

        document.getElementById('reflect-events-btn').addEventListener('click', async () => {
            const selectedItems = [];
            document.querySelectorAll('.event-checkbox:checked').forEach(checkbox => {
                const eventRow = checkbox.closest('.p-2');
                const projectSelect = eventRow.querySelector('.event-project-select');
                if (projectSelect && projectSelect.value) {
                    selectedItems.push({
                        event: JSON.parse(checkbox.dataset.event),
                        projectCode: projectSelect.value
                    });
                }
            });

            if (selectedItems.length === 0) {
                showStatus("プロジェクトが選択された予定にチェックを入れてください。", true, 'reflect-status');
                return;
            }
            
            showStatus("実績を登録しています...", false, 'reflect-status');

            const promises = selectedItems.map(item => {
                const project = Array.from(projectDataMap.values()).find(p => p.code === item.projectCode);
                if (!project) return Promise.reject(new Error(`プロジェクト ${item.projectCode} が見つかりません`));

                const clockInTime = new Date(item.event.start);
                const clockOutTime = new Date(item.event.end);
                const durationHours = (clockOutTime - clockInTime) / 3600000;

                return addDoc(collection(db, "timestamps"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    projectCode: project.code,
                    projectName: project.name,
                    clockInTime: Timestamp.fromDate(clockInTime),
                    clockOutTime: Timestamp.fromDate(clockOutTime),
                    durationHours: parseFloat(durationHours.toFixed(2)),
                    gCalEventId: item.event.id // ★★★ カレンダーのイベントIDを保存 ★★★
                });
            });

            try {
                await Promise.all(promises);
                showStatus(`${selectedItems.length}件の稼働実績を登録しました。`, false, 'reflect-status');
                listCalendarEvents(); // リストを再読み込みしてリフレッシュ
            } catch (error) {
                showStatus(`登録に失敗しました: ${error.message}`, true, 'reflect-status');
            }
        });
        
        // ★★★ 稼働実績の修正モーダル関連のロジック ★★★
        const editModal = document.getElementById('edit-timestamp-modal');
        const editForm = document.getElementById('edit-timestamp-form');
        const cancelEditBtn = document.getElementById('cancel-edit-timestamp');

        function formatDateTimeForInput(date) {
            if (!date) return '';
            const d = new Date(date);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        }
        
        function openEditTimestampModal(recordId) {
            let recordToEdit = null;
            for (const month in fullDashboardData) {
                for (const projectCode in fullDashboardData[month]) {
                    const found = fullDashboardData[month][projectCode].details.find(d => d.recordId === recordId);
                    if (found) {
                        recordToEdit = found;
                        break;
                    }
                }
                if (recordToEdit) break;
            }

            if (!recordToEdit) {
                alert("編集対象の記録が見つかりません。");
                return;
            }
            
            document.getElementById('edit-timestamp-id').value = recordId;
            document.getElementById('edit-start-time').value = formatDateTimeForInput(recordToEdit.clockIn);
            document.getElementById('edit-end-time').value = formatDateTimeForInput(recordToEdit.clockOut);
            document.getElementById('edit-project-select').value = recordToEdit.projectCode;
            
            editModal.classList.remove('hidden');
        }

        cancelEditBtn.addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const recordId = document.getElementById('edit-timestamp-id').value;
            const newStartTime = new Date(document.getElementById('edit-start-time').value);
            const newEndTime = new Date(document.getElementById('edit-end-time').value);
            const newProjectCode = document.getElementById('edit-project-select').value;
            
            if (newEndTime <= newStartTime) {
                alert("終了時間は開始時間より後に設定してください。");
                return;
            }

            const newDuration = (newEndTime - newStartTime) / 3600000;
            const project = Array.from(projectDataMap.values()).find(p => p.code === newProjectCode);

            const docRef = doc(db, "timestamps", recordId);
            try {
                await updateDoc(docRef, {
                    clockInTime: Timestamp.fromDate(newStartTime),
                    clockOutTime: Timestamp.fromDate(newEndTime),
                    durationHours: parseFloat(newDuration.toFixed(2)),
                    projectCode: newProjectCode,
                    projectName: project.name
                });
                editModal.classList.add('hidden');
                showStatus("実績を更新しました。", false, 'summaryStatus');
            } catch (error) {
                alert("更新に失敗しました: " + error.message);
            }
        });

    </script>
</body>
</html>
