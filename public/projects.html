<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロジェクト管理 - 打刻アプリ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <!-- この div に共通ヘッダーが挿入されます -->
    <div id="header-placeholder"></div>

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <!-- ★★★ 修正点：ここにあった <header>...</header> ブロックを削除しました ★★★ -->

        <main class="w-full max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold mb-6">プロジェクト管理</h1>
            <div id="projectManagementStatus" class="mb-4 text-sm"></div>

            <!-- Add Project Form -->
            <div class="bg-gray-50 p-6 rounded-lg mb-6">
                <h2 class="text-xl font-semibold mb-4">新規プロジェクト追加</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="newProjectCode" class="block text-sm font-medium text-gray-700">プロジェクトコード</label>
                        <input type="text" id="newProjectCode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-main focus:border-main" placeholder="P001">
                    </div>
                    <div>
                        <label for="newProjectName" class="block text-sm font-medium text-gray-700">プロジェクト名</label>
                        <input type="text" id="newProjectName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-main focus:border-main" placeholder="〇〇開発案件">
                    </div>
                    <button id="addProjectBtn" class="bg-main text-white py-2 px-4 rounded-lg font-bold hover:bg-main-dark btn h-10">追加</button>
                </div>
            </div>

            <!-- Project List -->
            <div>
                <h2 class="text-xl font-semibold mb-4">プロジェクト一覧</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 border-b text-left">コード</th>
                                <th class="py-2 px-4 border-b text-left">名前</th>
                                <th class="py-2 px-4 border-b text-left">ステータス</th>
                                <th class="py-2 px-4 border-b text-left">アクション</th>
                            </tr>
                        </thead>
                        <tbody id="projectList">
                            <!-- Project items will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializePage, db, showStatus } from './shared.js';
        import { collection, query, where, onSnapshot, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let currentUser;

        initializePage((user) => {
            currentUser = user;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            listenToProjects();
        });

        function listenToProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                const projectList = document.getElementById('projectList');
                projectList.innerHTML = '';
                if (snapshot.empty) {
                    projectList.innerHTML = '<tr><td colspan="4" class="text-center py-4">プロジェクトがありません。</td></tr>';
                    return;
                }
                const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                projects.sort((a,b) => a.code.localeCompare(b.code)).forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="py-2 px-4">${p.code}</td>
                        <td class="py-2 px-4">${p.name}</td>
                        <td class="py-2 px-4">
                            <select data-id="${p.id}" class="project-status-select p-1 border rounded-md">
                                <option value="Active" ${p.status === 'Active' ? 'selected' : ''}>有効</option>
                                <option value="Inactive" ${p.status === 'Inactive' ? 'selected' : ''}>無効</option>
                                <option value="Archived" ${p.status === 'Archived' ? 'selected' : ''}>アーカイブ</option>
                            </select>
                        </td>
                        <td class="py-2 px-4">
                            <button data-id="${p.id}" class="delete-project-btn text-red-500 hover:text-red-700 text-sm">削除</button>
                        </td>
                    `;
                    projectList.appendChild(row);
                });
            });
        }

        document.getElementById('projectList').addEventListener('change', async (e) => {
            if (e.target.classList.contains('project-status-select')) {
                const docId = e.target.dataset.id;
                const newStatus = e.target.value;
                await updateProjectStatus(docId, newStatus);
            }
        });

        document.getElementById('projectList').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-project-btn')) {
                if (confirm('本当にこのプロジェクトを削除しますか？関連する打刻記録は削除されません。')) {
                    const docId = e.target.dataset.id;
                    await deleteProject(docId);
                }
            }
        });
        
        async function deleteProject(docId) {
            showStatus("削除しています...", false, 'projectManagementStatus');
            try {
                await deleteDoc(doc(db, "projects", docId));
                showStatus("プロジェクトを削除しました。", false, 'projectManagementStatus');
            } catch (error) {
                showStatus(`削除エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        async function updateProjectStatus(docId, status) {
            showStatus("更新しています...", false, 'projectManagementStatus');
            try {
                const projectRef = doc(db, "projects", docId);
                await updateDoc(projectRef, { status: status });
                showStatus("ステータスを更新しました。", false, 'projectManagementStatus');
            } catch (error) {
                showStatus(`更新エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        document.getElementById('addProjectBtn').addEventListener('click', async () => {
            if (!currentUser) return;
            const codeInput = document.getElementById('newProjectCode');
            const nameInput = document.getElementById('newProjectName');
            const code = codeInput.value.trim();
            const name = nameInput.value.trim();
            if (!code || !name) {
                showStatus("エラー: コードと名前は必須です。", true, 'projectManagementStatus');
                return;
            }
            showStatus("追加しています...", false, 'projectManagementStatus');
            try {
                const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) throw new Error("同じプロジェクトコードが既に存在します。");
                await addDoc(collection(db, "projects"), {
                    code: code, name: name, status: "Active", color: "#698966", ownerId: currentUser.uid
                });
                showStatus("プロジェクトを追加しました。", false, 'projectManagementStatus');
                codeInput.value = ''; nameInput.value = '';
            } catch (error) {
                showStatus(`追加エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        });
    </script>
</body>
</html>
