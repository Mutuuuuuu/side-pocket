<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロジェクト管理 - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <div id="header-placeholder"></div>

        <main class="w-full max-w-4xl mx-auto">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">プロジェクト管理</h2>
                    <button id="open-add-project-modal-btn" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded">
                        新しいプロジェクトを追加
                    </button>
                </header>

                <div id="project-list" class="space-y-4">
                    <!-- プロジェクトがここに動的に挿入されます -->
                    <p class="text-gray-500 text-center py-4">プロジェクトを読み込み中...</p>
                </div>
                <div id="project-status" class="text-center h-5 mt-4"></div>
            </div>
        </main>
    </div>

    <!-- プロジェクト追加/編集モーダル -->
    <div id="project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <!-- max-h-[90vh]とoverflow-y-autoを追加してスクロール可能にする -->
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-bold mb-4">新しいプロジェクトを追加</h3>
            <form id="project-form" class="space-y-4">
                <input type="hidden" id="project-id">
                <div>
                    <label for="projectName" class="block text-sm font-medium text-gray-700">プロジェクト名:</label>
                    <input type="text" id="projectName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="projectCode" class="block text-sm font-medium text-gray-700">プロジェクトコード:</label>
                    <input type="text" id="projectCode" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="projectColor" class="block text-sm font-medium text-gray-700">色:</label>
                    <input type="color" id="projectColor" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" value="#4F46E5">
                </div>

                <!-- 新しい契約管理フィールド -->
                <div>
                    <label for="contractType" class="block text-sm font-medium text-gray-700">契約種類:</label>
                    <select id="contractType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        <option value="">選択してください</option>
                        <option value="fixed">固定清算</option>
                        <option value="hourly">時給清算</option>
                    </select>
                </div>

                <!-- 基本時給と作業時間単位を横並びに配置 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="baseHourlyRate" class="block text-sm font-medium text-gray-700">基本時給 (円):</label>
                        <input type="number" id="baseHourlyRate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="0" required>
                    </div>
                    <div>
                        <label for="workTimeUnit" class="block text-sm font-medium text-gray-700">作業時間単位:</label>
                        <select id="workTimeUnit" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">選択してください</option>
                            <option value="60">1時間単位 (60分)</option>
                            <option value="30">30分単位</option>
                            <option value="15">15分単位</option>
                            <option value="1">1分単位</option>
                        </select>
                    </div>
                </div>

                <div id="fixedContractFields" class="space-y-4 hidden">
                    <div>
                        <label for="baseWorkingHours" class="block text-sm font-medium text-gray-700">基本稼働時間 (時間):</label>
                        <input type="number" id="baseWorkingHours" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="billingRangeStart" class="block text-sm font-medium text-gray-700">清算幅 開始 (時間):</label>
                        <input type="number" id="billingRangeStart" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="0" step="0.01">
                    </div>
                    <div>
                        <label for="billingRangeEnd" class="block text-sm font-medium text-gray-700">清算幅 終了 (時間):</label>
                        <input type="number" id="billingRangeEnd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" min="0" step="0.01">
                    </div>
                </div>

                <!-- 契約期間 開始日と終了日を横並びに配置 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="contractPeriodStart" class="block text-sm font-medium text-gray-700">契約期間 開始日:</label>
                        <input type="date" id="contractPeriodStart" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="contractPeriodEnd" class="block text-sm font-medium text-gray-700">契約期間 終了日:</label>
                        <input type="date" id="contractPeriodEnd" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-project-btn" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">キャンセル</button>
                    <button type="submit" class="btn bg-main hover:bg-main-dark text-white font-bold py-2 px-4 rounded">保存</button>
                </div>
            </form>
            <div id="modal-status" class="text-center h-5 mt-4"></div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">プロジェクトを削除</h3>
            <p class="mb-6 text-gray-700">このプロジェクトを本当に削除しますか？</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete-btn" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">キャンセル</button>
                <button type="button" id="confirm-delete-btn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">削除</button>
            </div>
            <div id="delete-status" class="text-center h-5 mt-4"></div>
        </div>
    </div>

    <script type="module">
        import { collection, query, where, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js';

        let currentUser = null;
        let currentProjectToDeleteId = null;

        // DOM要素の取得
        const projectList = document.getElementById('project-list');
        const projectStatusElement = document.getElementById('project-status');
        const openAddProjectModalBtn = document.getElementById('open-add-project-modal-btn');
        const projectModal = document.getElementById('project-modal');
        const modalTitle = document.getElementById('modal-title');
        const projectForm = document.getElementById('project-form');
        const projectIdInput = document.getElementById('project-id');
        const projectNameInput = document.getElementById('projectName');
        const projectCodeInput = document.getElementById('projectCode');
        const projectColorInput = document.getElementById('projectColor');
        const cancelProjectBtn = document.getElementById('cancel-project-btn');
        const modalStatusElement = document.getElementById('modal-status');

        // 新しい契約管理フィールドのDOM要素
        const contractTypeSelect = document.getElementById('contractType');
        const baseHourlyRateInput = document.getElementById('baseHourlyRate');
        const fixedContractFieldsDiv = document.getElementById('fixedContractFields');
        const baseWorkingHoursInput = document.getElementById('baseWorkingHours');
        const billingRangeStartInput = document.getElementById('billingRangeStart');
        const billingRangeEndInput = document.getElementById('billingRangeEnd');
        const contractPeriodStartInput = document.getElementById('contractPeriodStart');
        const contractPeriodEndInput = document.getElementById('contractPeriodEnd');
        const workTimeUnitSelect = document.getElementById('workTimeUnit');

        // 削除確認モーダル
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteStatusElement = document.getElementById('delete-status');

        /**
         * Firebase認証完了後に呼び出されるメインのセットアップ関数
         * @param {object} user - Firebase認証ユーザーオブジェクト
         */
        async function setupProjectPage(user) {
            currentUser = user;
            if (!currentUser) {
                showStatus("ユーザーが認証されていません。", true, 'project-status');
                return;
            }

            // イベントリスナーの設定
            openAddProjectModalBtn.addEventListener('click', openAddProjectModal);
            cancelProjectBtn.addEventListener('click', closeProjectModal);
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
            confirmDeleteBtn.addEventListener('click', handleDeleteConfirmed);

            // 契約種類の変更に応じて固定清算フィールドの表示を切り替える
            contractTypeSelect.addEventListener('change', toggleFixedContractFields);

            // プロジェクトリストのリアルタイムリスナーを設定
            listenToProjects();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }

        /**
         * 契約種類の選択に応じて固定清算関連フィールドの表示を切り替える
         */
        function toggleFixedContractFields() {
            if (contractTypeSelect.value === 'fixed') {
                fixedContractFieldsDiv.classList.remove('hidden');
                // 固定清算の場合、基本稼働時間と清算幅を必須にする (HTMLのrequiredは動的に設定できないため、JSで制御)
                baseWorkingHoursInput.setAttribute('required', 'true');
                billingRangeStartInput.setAttribute('required', 'true');
                billingRangeEndInput.setAttribute('required', 'true');
            } else {
                fixedContractFieldsDiv.classList.add('hidden');
                // 固定清算でない場合、必須属性を削除し、値をクリア
                baseWorkingHoursInput.removeAttribute('required');
                billingRangeStartInput.removeAttribute('required');
                billingRangeEndInput.removeAttribute('required');
                baseWorkingHoursInput.value = '';
                billingRangeStartInput.value = '';
                billingRangeEndInput.value = '';
            }
        }

        /**
         * プロジェクトリストをFirestoreからリアルタイムで購読する
         */
        function listenToProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                projectList.innerHTML = ''; // リストをクリア
                if (snapshot.empty) {
                    projectList.innerHTML = '<p class="text-gray-500 text-center py-4">まだプロジェクトがありません。「新しいプロジェクトを追加」から作成してください。</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const project = { id: doc.id, ...doc.data() };
                    renderProject(project);
                });
                showStatus("プロジェクトリストを更新しました。", false, 'project-status');
            }, (error) => {
                console.error("Error listening to projects:", error);
                showStatus("プロジェクトの読み込みに失敗しました。", true, 'project-status');
            });
        }

        /**
         * プロジェクトをHTMLにレンダリングする
         * @param {object} project - プロジェクトデータ
         */
        function renderProject(project) {
            const projectCard = document.createElement('div');
            projectCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0';
            projectCard.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${project.color || '#4F46E5'};"></div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${project.name}</h3>
                        <p class="text-sm text-gray-500">${project.code}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="btn btn-sm bg-main hover:bg-main-dark text-white py-1 px-3 rounded text-xs edit-btn" data-id="${project.id}">編集</button>
                    <button class="btn btn-sm bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-xs delete-btn" data-id="${project.id}">削除</button>
                </div>
            `;
            projectList.appendChild(projectCard);

            // イベントリスナーをアタッチ
            projectCard.querySelector('.edit-btn').addEventListener('click', () => openEditProjectModal(project.id));
            projectCard.querySelector('.delete-btn').addEventListener('click', () => openDeleteConfirmModal(project.id));
        }

        /**
         * 新しいプロジェクト追加モーダルを開く
         */
        function openAddProjectModal() {
            modalTitle.textContent = '新しいプロジェクトを追加';
            projectForm.reset();
            projectIdInput.value = ''; // 新規追加時はIDをクリア
            projectColorInput.value = '#4F46E5'; // デフォルト色を設定
            contractTypeSelect.value = ''; // 契約種類をリセット
            toggleFixedContractFields(); // 固定清算フィールドを非表示に
            projectModal.classList.remove('hidden');
            showStatus('', false, 'modal-status');
        }

        /**
         * プロジェクト編集モーダルを開く
         * @param {string} projectId - 編集対象のプロジェクトID
         */
        async function openEditProjectModal(projectId) {
            modalTitle.textContent = 'プロジェクトを編集';
            showStatus("プロジェクトデータを読み込み中...", false, 'modal-status');
            try {
                const docRef = doc(db, "projects", projectId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    throw new Error("プロジェクトが見つかりませんでした。");
                }

                const project = docSnap.data();
                projectIdInput.value = docSnap.id;
                projectNameInput.value = project.name || '';
                projectCodeInput.value = project.code || '';
                projectColorInput.value = project.color || '#4F46E5';

                // 新しい契約管理フィールドの値を設定
                contractTypeSelect.value = project.contractType || '';
                baseHourlyRateInput.value = project.baseHourlyRate || '';
                baseWorkingHoursInput.value = project.baseWorkingHours || '';
                billingRangeStartInput.value = project.billingRangeStart || '';
                billingRangeEndInput.value = project.billingRangeEnd || '';
                contractPeriodStartInput.value = project.contractPeriodStart ? project.contractPeriodStart.toDate().toISOString().substring(0, 10) : '';
                contractPeriodEndInput.value = project.contractPeriodEnd ? project.contractPeriodEnd.toDate().toISOString().substring(0, 10) : '';
                workTimeUnitSelect.value = project.workTimeUnit || '';

                toggleFixedContractFields(); // 契約種類に応じてフィールド表示を更新

                projectModal.classList.remove('hidden');
                showStatus('', false, 'modal-status');
            } catch (error) {
                console.error("Error loading project for edit:", error);
                showStatus(`プロジェクトの読み込みに失敗しました: ${error.message}`, true, 'modal-status');
            }
        }

        /**
         * プロジェクト追加/編集モーダルを閉じる
         */
        function closeProjectModal() {
            projectModal.classList.add('hidden');
            projectForm.reset();
            showStatus('', false, 'modal-status');
        }

        /**
         * プロジェクトフォームの送信ハンドラー (追加または更新)
         * @param {Event} event - フォーム送信イベント
         */
        async function handleProjectFormSubmit(event) {
            event.preventDefault();
            showStatus("保存中...", false, 'modal-status');

            const projectId = projectIdInput.value;
            const name = projectNameInput.value.trim();
            const code = projectCodeInput.value.trim();
            const color = projectColorInput.value;

            // 新しい契約管理フィールドの値を取得
            const contractType = contractTypeSelect.value;
            const baseHourlyRate = parseFloat(baseHourlyRateInput.value);
            const workTimeUnit = parseInt(workTimeUnitSelect.value);

            // 固定清算の場合のみ取得するフィールド
            let baseWorkingHours = null;
            let billingRangeStart = null;
            let billingRangeEnd = null;
            if (contractType === 'fixed') {
                baseWorkingHours = parseFloat(baseWorkingHoursInput.value);
                billingRangeStart = parseFloat(billingRangeStartInput.value);
                billingRangeEnd = parseFloat(billingRangeEndInput.value);

                // 固定清算の場合の必須チェック
                if (isNaN(baseWorkingHours) || baseWorkingHours < 0) {
                    showStatus("基本稼働時間を正しく入力してください。", true, 'modal-status');
                    return;
                }
                if (isNaN(billingRangeStart) || isNaN(billingRangeEnd) || billingRangeStart < 0 || billingRangeEnd < 0 || billingRangeStart > billingRangeEnd) {
                    showStatus("清算幅を正しく入力してください (開始 <= 終了)。", true, 'modal-status');
                    return;
                }
            }

            const contractPeriodStart = contractPeriodStartInput.value ? Timestamp.fromDate(new Date(contractPeriodStartInput.value)) : null;
            const contractPeriodEnd = contractPeriodEndInput.value ? Timestamp.fromDate(new Date(contractPeriodEndInput.value)) : null;

            if (!name || !code || !contractType || isNaN(baseHourlyRate) || baseHourlyRate < 0 || isNaN(workTimeUnit) || workTimeUnit <= 0) {
                showStatus("必須フィールドをすべて入力してください。", true, 'modal-status');
                return;
            }
            
            const projectData = {
                name: name,
                code: code,
                color: color,
                ownerId: currentUser.uid,
                contractType: contractType,
                baseHourlyRate: baseHourlyRate,
                workTimeUnit: workTimeUnit,
                createdAt: projectId ? undefined : Timestamp.now(), // 新規作成時のみ設定
                updatedAt: Timestamp.now()
            };

            if (contractType === 'fixed') {
                projectData.baseWorkingHours = baseWorkingHours;
                projectData.billingRangeStart = billingRangeStart;
                projectData.billingRangeEnd = billingRangeEnd;
            } else {
                // 時給清算の場合、固定清算関連フィールドはFirestoreから削除またはnullにする
                projectData.baseWorkingHours = null;
                projectData.billingRangeStart = null;
                projectData.billingRangeEnd = null;
            }

            if (contractPeriodStart) projectData.contractPeriodStart = contractPeriodStart;
            if (contractPeriodEnd) projectData.contractPeriodEnd = contractPeriodEnd;

            try {
                if (projectId) {
                    // 既存プロジェクトの更新
                    const projectRef = doc(db, "projects", projectId);
                    await updateDoc(projectRef, projectData);
                    showStatus("プロジェクトが更新されました！", false, 'modal-status');
                } else {
                    // 新しいプロジェクトの追加
                    await addDoc(collection(db, "projects"), projectData);
                    showStatus("プロジェクトが追加されました！", false, 'modal-status');
                }
                closeProjectModal();
            } catch (error) {
                console.error("Error saving project:", error);
                showStatus(`プロジェクトの保存に失敗しました: ${error.message}`, true, 'modal-status');
            }
        }

        /**
         * 削除確認モーダルを開く
         * @param {string} projectId - 削除対象のプロジェクトID
         */
        function openDeleteConfirmModal(projectId) {
            currentProjectToDeleteId = projectId;
            deleteConfirmModal.classList.remove('hidden');
            showStatus('', false, 'delete-status');
        }

        /**
         * 削除確認モーダルを閉じる
         */
        function closeDeleteConfirmModal() {
            deleteConfirmModal.classList.add('hidden');
            currentProjectToDeleteId = null;
            showStatus('', false, 'delete-status');
        }

        /**
         * 削除が確定されたときのハンドラー
         */
        async function handleDeleteConfirmed() {
            if (!currentProjectToDeleteId) return;

            showStatus("削除中...", false, 'delete-status');
            try {
                await deleteDoc(doc(db, "projects", currentProjectToDeleteId));
                showStatus("プロジェクトが削除されました！", false, 'delete-status');
                closeDeleteConfirmModal();
            } catch (error) {
                console.error("Error deleting project:", error);
                showStatus(`プロジェクトの削除に失敗しました: ${error.message}`, true, 'delete-status');
            }
        }

        // 共通の初期化処理を呼び出し、認証完了後にプロジェクトページの処理を実行
        initializePage(setupProjectPage);
    </script>
</body>
</html>
