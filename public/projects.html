<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロジェクト管理 - side pocket</title>
    <link rel="icon" href="images/sidepocket_symbol.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="loader"></div><p class="ml-4 text-lg">読み込んでいます...</p>
    </div>

    <div id="app-container" class="w-full" style="display: none;">
        <div id="header-placeholder"></div>

        <main class="w-full max-w-2xl mx-auto">
            <div class="p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-lg">
                <header><h2 class="text-2xl sm:text-3xl font-bold text-gray-800">プロジェクト管理</h2></header>
                <div id="projectManagementStatus" class="text-center font-medium h-8"></div>
                <div class="p-4 border rounded-lg space-y-3">
                    <h3 class="text-lg font-bold">新規プロジェクト追加</h3>
                    <input type="text" id="newProjectCode" placeholder="プロジェクトコード (例: P-001)" class="w-full p-2 border rounded">
                    <input type="text" id="newProjectName" placeholder="プロジェクト名" class="w-full p-2 border rounded">
                    <button id="addProjectBtn" class="btn w-full text-white bg-main hover:bg-main-dark p-2 rounded-lg">追加</button>
                </div>
                <div class="space-y-3">
                    <h3 class="text-lg font-bold">プロジェクト一覧</h3>
                    <div id="projectListContainer" class="space-y-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { collection, addDoc, query, where, orderBy, doc, updateDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializePage, auth, db, showStatus } from './shared.js';

        let currentUser = null;
        const projectDataMap = new Map();

        initializePage(user => {
            currentUser = user;
            listenToAllProjects();
        });

        function listenToAllProjects() {
            if (!currentUser) return;
            const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), orderBy("code"));
            onSnapshot(q, (snapshot) => {
                const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjectList(projects);
            }, (error) => {
                showStatus("プロジェクトリストの取得に失敗しました。", true, 'projectManagementStatus');
            });
        }
        
        function renderProjectItem(p) {
            return `<div class="project-item flex justify-between items-center p-3 border-b gap-2 rounded-lg bg-white shadow-sm" data-project-id="${p.id}">
                <input type="color" class="project-color-input p-1 h-10 w-10 block bg-white border border-gray-200 cursor-pointer rounded-lg" value="${p.color || '#698966'}">
                <div class="flex-grow">
                    <div data-field="name" class="font-bold text-gray-800">${p.name}</div>
                    <div class="text-sm text-gray-500">${p.code}</div>
                </div>
                <div class="flex items-center gap-2" data-role="action-buttons">
                    <button class="edit-project-btn btn text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">修正</button>
                    <label class="switch"><input type="checkbox" class="project-status-toggle" ${p.status === 'Active' ? 'checked' : ''}><span class="slider"></span></label>
                </div>
            </div>`;
        }
        
        function renderProjectList(projects) {
            const container = document.getElementById('projectListContainer');
            projectDataMap.clear();
            if (!projects || projects.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">プロジェクトがありません。</p>';
                return;
            }
            container.innerHTML = projects.map(p => {
                projectDataMap.set(p.id, p);
                return renderProjectItem(p);
            }).join('');
        }

        document.getElementById('projectListContainer').addEventListener('change', (e) => {
            if (e.target.classList.contains('project-color-input') || e.target.classList.contains('project-status-toggle')) {
                handleProjectUpdate(e.target);
            }
        });

        document.getElementById('projectListContainer').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('edit-project-btn')) {
                toggleProjectEdit(target);
            } else if (target.classList.contains('save-project-btn')) {
                saveProjectName(target);
            } else if (target.classList.contains('cancel-project-btn')) {
                cancelProjectEdit(target);
            }
        });

        function toggleProjectEdit(button) {
            const projectItem = button.closest('.project-item');
            const nameDiv = projectItem.querySelector('[data-field="name"]');
            const actionButtonsDiv = projectItem.querySelector('[data-role="action-buttons"]');
            const currentName = nameDiv.textContent;
            nameDiv.innerHTML = `<input type="text" class="project-name-input w-full p-1 border rounded" value="${currentName}">`;
            actionButtonsDiv.innerHTML = `<button class="save-project-btn btn text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">保存</button>
                <button class="cancel-project-btn btn text-sm bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500">取消</button>`;
            projectItem.querySelector('.project-name-input').focus();
        }

        function cancelProjectEdit(button) {
            const projectItem = button.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            const originalProject = projectDataMap.get(projectId);
            if (originalProject) {
                const nameDiv = projectItem.querySelector('[data-field="name"]');
                const actionButtonsDiv = projectItem.querySelector('[data-role="action-buttons"]');
                nameDiv.textContent = originalProject.name;
                actionButtonsDiv.innerHTML = `<button class="edit-project-btn btn text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300">修正</button>
                    <label class="switch"><input type="checkbox" class="project-status-toggle" ${originalProject.status === 'Active' ? 'checked' : ''}><span class="slider"></span></label>`;
            }
        }

        async function saveProjectName(button) {
            const projectItem = button.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            const nameInput = projectItem.querySelector('.project-name-input');
            const newName = nameInput.value.trim();
            if (!newName) {
                showStatus('プロジェクト名は必須です。', true, 'projectManagementStatus');
                return;
            }
            showStatus('プロジェクト名を更新しています...', false, 'projectManagementStatus');
            const docRef = doc(db, "projects", projectId);
            try {
                await updateDoc(docRef, { name: newName });
                showStatus('更新しました。', false, 'projectManagementStatus');
                const updatedProject = { ...projectDataMap.get(projectId), name: newName };
                projectDataMap.set(projectId, updatedProject);
                cancelProjectEdit(button);
            } catch (error) {
                showStatus(`更新エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        async function handleProjectUpdate(target) {
            const projectItem = target.closest('.project-item');
            const projectId = projectItem.dataset.projectId;
            if (!projectId) return;
            const docRef = doc(db, "projects", projectId);
            try {
                const updateData = {};
                if (target.type === 'checkbox') {
                    updateData.status = target.checked ? 'Active' : 'Inactive';
                    showStatus("ステータスを更新しています...", false, 'projectManagementStatus');
                } else if (target.type === 'color') {
                    updateData.color = target.value;
                    showStatus("色を更新しています...", false, 'projectManagementStatus');
                }
                await updateDoc(docRef, updateData);
                showStatus("更新しました。", false, 'projectManagementStatus');
                const currentProject = projectDataMap.get(projectId);
                projectDataMap.set(projectId, { ...currentProject, ...updateData });
            } catch (error) {
                showStatus(`更新エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        }

        document.getElementById('addProjectBtn').addEventListener('click', async () => {
            if (!currentUser) return;
            const codeInput = document.getElementById('newProjectCode');
            const nameInput = document.getElementById('newProjectName');
            const code = codeInput.value.trim();
            const name = nameInput.value.trim();
            if (!code || !name) {
                showStatus("エラー: コードと名前は必須です。", true, 'projectManagementStatus');
                return;
            }
            showStatus("追加しています...", false, 'projectManagementStatus');
            try {
                const q = query(collection(db, "projects"), where("ownerId", "==", currentUser.uid), where("code", "==", code));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) throw new Error("同じプロジェクトコードが既に存在します。");
                await addDoc(collection(db, "projects"), {
                    code: code, name: name, status: "Active", color: "#698966", ownerId: currentUser.uid
                });
                showStatus("プロジェクトを追加しました。", false, 'projectManagementStatus');
                codeInput.value = ''; nameInput.value = '';
            } catch (error) {
                showStatus(`追加エラー: ${error.message}`, true, 'projectManagementStatus');
            }
        });
    </script>
</body>
</html>
